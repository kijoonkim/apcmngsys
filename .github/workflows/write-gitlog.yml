name: Generate PR CSV

on:
  workflow_dispatch:
    inputs:
      since:
        description: 'YYYY-MM-DD í˜•ì‹ì˜ ì‹œì‘ ë‚ ì§œ'
        required: true
        type: string

jobs:
  export-pr-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up GitHub CLI
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install GitHub CLI
        run: sudo apt-get install gh -y

      - name: Authenticate GH CLI
        run: gh auth setup-git
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch PRs since ${{ inputs.since }}
        run: |
          echo '"ì‘ì„±ì","ì‘ì„±ì¼","ìš”êµ¬ì‚¬í•­","ìˆ˜ì •ëœíŒŒì¼","ì¶”ê°€ëœíŒŒì¼","ì‚­ì œëœíŒŒì¼"' > pr-log.csv

          gh pr list --state all --json author,createdAt,body --limit 1000 | \
          jq -r --arg since "${{ inputs.since }}" '
            .[] |
            select(.createdAt >= ($since + "T00:00:00Z")) |
            {
              author: .author.login,
              createdAt: .createdAt,
              body: .body
            } |
            . as $pr |
            {
              author: $pr.author,
              createdAt: ($pr.createdAt | split("T")[0]),
              ìš”êµ¬ì‚¬í•­: ($pr.body | capture("## ğŸ› ï¸ ìš”êµ¬ì‚¬í•­\\n(?<req>(.*\\n)*?)##")?.req // "" | gsub("[\\r\\n]+"; " ") | gsub("\""; "'")),
              ìˆ˜ì •: ($pr.body | capture("## ğŸ“ ìˆ˜ì •ëœ íŒŒì¼\\n(?<mod>(- .*(\\n|$))+)" )?.mod // "" | gsub("- "; "" ) | gsub("[\\r\\n]+"; "\\n") | gsub("\""; "'")),
              ì¶”ê°€: ($pr.body | capture("## ğŸ“„ ì¶”ê°€ëœ íŒŒì¼\\n(?<add>(- .*(\\n|$))+)" )?.add // "" | gsub("- "; "" ) | gsub("[\\r\\n]+"; "\\n") | gsub("\""; "'")),
              ì‚­ì œ: ($pr.body | capture("## âŒ ì‚­ì œëœ íŒŒì¼\\n(?<del>(- .*(\\n|$))+)" )?.del // "" | gsub("- "; "" ) | gsub("[\\r\\n]+"; "\\n") | gsub("\""; "'"))
            } |
            "\"\(.author)\",\"\(.createdAt)\",\"\(.ìš”êµ¬ì‚¬í•­)\",\"\(.ìˆ˜ì •)\",\"\(.ì¶”ê°€)\",\"\(.ì‚­ì œ)\""
          ' >> pr-log.csv

      - name: Upload CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-log
          path: pr-log.csv
