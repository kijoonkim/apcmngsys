<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- ==========================================================================	-->
<!-- NAME : ClclnWkrptMapper.xml                                   				-->
<!-- DESC : 주간 입고출고현황 mapper                   				            -->
<!-- ==========================================================================	-->
<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
<!-- ===========  	============  	===========================================	-->
<!-- 2024.11.12  	김호        	Initial Creation                            -->
<!-- ==========================================================================	-->

<mapper namespace="com.at.apcss.am.clcln.mapper.ClclnWkrptMapper">

    <!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.am.clcln.mapper.ClclnWkrptMapper.selectWkrptList		-->
	<!-- DESC : 주간 입출고현황 			                        	            -->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2024.11.12  	김호        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <select id="selectWkrptListTEST" parameterType="com.at.apcss.am.clcln.vo.ClclnWkrptVO" resultType="com.at.apcss.am.clcln.vo.ClclnWkrptVO">
    	<![CDATA[
			SELECT /* com.at.apcss.am.clcln.mapper.ClclnWkrptMapper.selectWkrptList */
			       Z.APC_CD
			     , Z.WRHS_SPMT_TYPE
			     , (SELECT FN_GET_COM_CD_VL_NM('WRHS_SPMT_TYPE', z.WRHS_SPMT_TYPE) FROM DUAL) AS WRHS_SPMT_TYPE_NM
			     , Z.PRDCR_CD
			     , MAX(Z.BX_QNTT_MON)               AS BX_QNTT_MON
			     , MAX(Z.PRDCR_NM_MON)              AS PRDCR_NM_MON
			     , MAX(Z.BX_QNTT_TUE)               AS BX_QNTT_TUE
			     , MAX(Z.PRDCR_NM_TUE)              AS PRDCR_NM_TUE
			     , MAX(Z.BX_QNTT_WED)               AS BX_QNTT_WED
			     , MAX(Z.PRDCR_NM_WED)              AS PRDCR_NM_WED
			     , MAX(Z.BX_QNTT_THU)               AS BX_QNTT_THU
			     , MAX(Z.PRDCR_NM_THU)              AS PRDCR_NM_THU
			     , MAX(Z.BX_QNTT_FRI)               AS BX_QNTT_FRI
			     , MAX(Z.PRDCR_NM_FRI)              AS PRDCR_NM_FRI
			     , MAX(Z.BX_QNTT_SAT)               AS BX_QNTT_SAT
			     , MAX(Z.PRDCR_NM_SAT)              AS PRDCR_NM_SAT
			     , MAX(Z.BX_QNTT_SUN)               AS BX_QNTT_SUN
			     , MAX(Z.PRDCR_NM_SUN)              AS PRDCR_NM_SUN
		         , MAX(Z.TOT_WRHS_QNTT)             AS TOT_WRHS_QNTT
     			 , MAX(Z.TOT_SPMT_QNTT)             AS TOT_SPMT_QNTT
			  FROM( SELECT Y.APC_CD
			             , Y.WRHS_SPMT_TYPE
			             , Y.PRDCR_CD
			             , Y.WGH_YMD
			             , CASE WHEN WGH_YMD = TO_CHAR(TRUNC(TO_DATE(Y.WGH_YMD,'YYYYMMDD'),'iw'), 'YYYYMMDD') THEN Y.BX_QNTT END BX_QNTT_MON
			             , CASE WHEN WGH_YMD = TO_CHAR(TRUNC(TO_DATE(Y.WGH_YMD,'YYYYMMDD'),'iw'), 'YYYYMMDD')
			                    THEN FN_GET_PRDCR_NM(Y.PRDCR_CD, Y.APC_CD) END PRDCR_NM_MON
			             , CASE WHEN WGH_YMD = TO_CHAR(TRUNC(TO_DATE(Y.WGH_YMD,'YYYYMMDD'),'iw')+1, 'YYYYMMDD') THEN Y.BX_QNTT END BX_QNTT_TUE
			             , CASE WHEN WGH_YMD = TO_CHAR(TRUNC(TO_DATE(Y.WGH_YMD,'YYYYMMDD'),'iw')+1, 'YYYYMMDD')
			                    THEN FN_GET_PRDCR_NM(Y.PRDCR_CD, Y.APC_CD) END PRDCR_NM_TUE
			             , CASE WHEN WGH_YMD = TO_CHAR(TRUNC(TO_DATE(Y.WGH_YMD,'YYYYMMDD'),'iw')+2, 'YYYYMMDD') THEN Y.BX_QNTT END BX_QNTT_WED
			             , CASE WHEN WGH_YMD = TO_CHAR(TRUNC(TO_DATE(Y.WGH_YMD,'YYYYMMDD'),'iw')+2, 'YYYYMMDD')
			                    THEN FN_GET_PRDCR_NM(Y.PRDCR_CD, Y.APC_CD) END PRDCR_NM_WED
			             , CASE WHEN WGH_YMD = TO_CHAR(TRUNC(TO_DATE(Y.WGH_YMD,'YYYYMMDD'),'iw')+3, 'YYYYMMDD') THEN Y.BX_QNTT END BX_QNTT_THU
			             , CASE WHEN WGH_YMD = TO_CHAR(TRUNC(TO_DATE(Y.WGH_YMD,'YYYYMMDD'),'iw')+3, 'YYYYMMDD')
			                    THEN FN_GET_PRDCR_NM(Y.PRDCR_CD, Y.APC_CD) END PRDCR_NM_THU
			             , CASE WHEN WGH_YMD = TO_CHAR(TRUNC(TO_DATE(Y.WGH_YMD,'YYYYMMDD'),'iw')+4, 'YYYYMMDD') THEN Y.BX_QNTT END BX_QNTT_FRI
			             , CASE WHEN WGH_YMD = TO_CHAR(TRUNC(TO_DATE(Y.WGH_YMD,'YYYYMMDD'),'iw')+4, 'YYYYMMDD')
			                    THEN FN_GET_PRDCR_NM(Y.PRDCR_CD, Y.APC_CD) END PRDCR_NM_FRI
			             , CASE WHEN WGH_YMD = TO_CHAR(TRUNC(TO_DATE(Y.WGH_YMD,'YYYYMMDD'),'iw')+5, 'YYYYMMDD') THEN Y.BX_QNTT END BX_QNTT_SAT
			             , CASE WHEN WGH_YMD = TO_CHAR(TRUNC(TO_DATE(Y.WGH_YMD,'YYYYMMDD'),'iw')+5, 'YYYYMMDD')
			                    THEN FN_GET_PRDCR_NM(Y.PRDCR_CD, Y.APC_CD) END PRDCR_NM_SAT
			             , CASE WHEN WGH_YMD = TO_CHAR(TRUNC(TO_DATE(Y.WGH_YMD,'YYYYMMDD'),'iw')+6, 'YYYYMMDD') THEN Y.BX_QNTT END BX_QNTT_SUN
			             , CASE WHEN WGH_YMD = TO_CHAR(TRUNC(TO_DATE(Y.WGH_YMD,'YYYYMMDD'),'iw')+6, 'YYYYMMDD')
			                    THEN FN_GET_PRDCR_NM(Y.PRDCR_CD, Y.APC_CD) END PRDCR_NM_SUN
			             , SUM(TOT_WRHS_QNTT) OVER()     AS TOT_WRHS_QNTT
			             , SUM(TOT_SPMT_QNTT) OVER()     AS TOT_SPMT_QNTT
			          FROM (
			                SELECT X.APC_CD                 AS APC_CD
			                     , X.WRHS_SPMT_TYPE         AS WRHS_SPMT_TYPE
			                     , X.WGH_YMD                AS WGH_YMD
			                     , X.PRDCR_CD               AS PRDCR_CD
			                     , SUM(X.BX_QNTT)           AS BX_QNTT
			                     , CASE WHEN X.WRHS_SPMT_TYPE = 'RT' THEN SUM(X.BX_QNTT) END TOT_WRHS_QNTT
			                     , CASE WHEN X.WRHS_SPMT_TYPE = 'DT' THEN SUM(X.BX_QNTT) END TOT_SPMT_QNTT
			                  FROM (
			                        SELECT WC.APC_CD
			                             , WC.WGHNO
			                             , WC.WGH_YMD
			                             , WC.WRHS_SPMT_TYPE
			                             , WD.BX_QNTT
			                             , WC.PRDCR_CD
			                          FROM TB_WGH_PRFMNC_COM WC
			                             , TB_WGH_PRFMNC_DTL WD
			                         WHERE WC.APC_CD = WD.APC_CD
			                           AND WC.WGHNO = WD.WGHNO
			                           AND WC.DEL_YN = 'N'
			                           AND WD.DEL_YN = 'N'
		]]>
			<if test='apcCd != null and apcCd != ""'>
			                   		   AND WC.APC_CD = #{apcCd}
			</if>
			<if test='wghYmdFrom != null and wghYmdFrom != ""'>
			   				   		   AND WC.WGH_YMD <![CDATA[>=]]> #{wghYmdFrom}
			</if>
			<if test='wghYmdTo != null and wghYmdTo != ""'>
			   				   		   AND WC.WGH_YMD <![CDATA[<=]]> #{wghYmdTo}
			</if>
		<![CDATA[

			                       ) X
			                 GROUP BY X.APC_CD, X.WRHS_SPMT_TYPE, X.WGH_YMD, X.PRDCR_CD
			                 ORDER BY X.WRHS_SPMT_TYPE DESC
			            ) Y
			    ) Z
			 GROUP BY Z.APC_CD, Z.WRHS_SPMT_TYPE, Z.PRDCR_CD
			 ORDER BY Z.WRHS_SPMT_TYPE
    	]]>
    </select>

    <!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.am.clcln.mapper.ClclnWkrptMapper.selectWkrptList		-->
	<!-- DESC : 주간 입출고현황 			                        	            -->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2025.02.20  	박승진        	Initial Creation                            -->
	<!-- ==========================================================================	-->
	<select id="selectWkrptList" parameterType="com.at.apcss.am.clcln.vo.ClclnWkrptVO"
			resultType="com.at.apcss.am.clcln.vo.ClclnWkrptVO">
		<![CDATA[
			SELECT
				pt0.*
     			, (SELECT FN_GET_COM_CD_VL_NM('WRHS_SPMT_TYPE', pt0.WRHS_SPMT_TYPE) FROM DUAL) AS WRHS_SPMT_TYPE_NM
     			, (SELECT FN_GET_PRDCR_NM(pt0.PRDCR_CD, pt0.APC_CD) FROM DUAL) AS PRDCR_NM
     			, TO_CHAR(TO_DATE(pt0.WGH_YMD, 'YYYYMMDD'), 'DY', 'NLS_DATE_LANGUAGE=KOREAN') AS DY
				, CASE WHEN pt0.ACTL_WGHT = 0 THEN WRHS_WGHT ELSE pt0.ACTL_WGHT - NVL(pt0.RDCD_WGHT, 0) END AS ACPTN_WGHT
			FROM (
			    SELECT
					WC.APC_CD		    	AS APC_CD
					, WC.WGHNO		      	AS WGHNO
					, WD.WGH_SN				AS WGH_SN
					, WD.WRHSNO		   		AS WRHSNO
					, WC.WGH_YMD           	AS WGH_YMD
					, WC.VHCLNO            	AS VHCLNO
					, WC.PRDCR_CD	        AS PRDCR_CD
					, WC.WHOL_WGHT         	AS WHOL_WGHT
					, WC.EMPT_VHCL_WGHT    	AS EMPT_VHCL_WGHT
					, WC.RDCD_RT           	AS RDCD_RT
					, WC.RDCD_WGHT         	AS RDCD_WGHT
					, WC.WRHS_WGHT         	AS WRHS_WGHT
					, WC.RMRK              	AS RMRK
					, WC.WRHS_SPMT_TYPE		AS WRHS_SPMT_TYPE
			        , WD.CNPT_CD			AS CNPT_CD
			        , WD.ITEM_CD			AS ITEM_CD
			        , WD.VRTY_CD			AS VRTY_CD
					, WD.GRD_CD            	AS GRD_CD
			        , WD.PLTNO				AS PLTNO
					, WD.PLT_KND		    AS PLT_KND
					, WD.PLT_WGHT          	AS PLT_WGHT
					, WD.BX_KND				AS BX_KND
					, WD.BX_QNTT           	AS BX_QNTT
					, WD.BX_WGHT           	AS BX_WGHT
			        , NVL(WC.WHOL_WGHT - WC.EMPT_VHCL_WGHT, 0) AS ACTL_WGHT
				FROM TB_WGH_PRFMNC_COM WC
           			, TB_WGH_PRFMNC_DTL WD
        	   WHERE WC.APC_CD = WD.APC_CD
          		 AND WC.WGHNO = WD.WGHNO
          		 AND WC.DEL_YN = 'N'
		         AND WD.DEL_YN = 'N'
		      ]]>
		<if test='apcCd != null and apcCd != ""'>
			AND WC.APC_CD = #{apcCd}
		</if>
		<if test='wghYmdFrom != null and wghYmdFrom != ""'>
			AND WC.WGH_YMD <![CDATA[>=]]> #{wghYmdFrom}
		</if>
		<if test='wghYmdTo != null and wghYmdTo != ""'>
			AND WC.WGH_YMD <![CDATA[<=]]> #{wghYmdTo}
		</if>
		) pt0
		ORDER BY pt0.WRHS_SPMT_TYPE, pt0.WGHNO ASC
	</select>

    <!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.am.clcln.mapper.ClclnWkrptMapper.selectWkrptLastQnttList	-->
	<!-- DESC : 전재고 조회 			                        	            	-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2025.02.20  	박승진        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <select id="selectWkrptLastQnttList" parameterType="com.at.apcss.am.clcln.vo.ClclnWkrptVO" resultType="com.at.apcss.am.clcln.vo.ClclnWkrptVO">
    	<![CDATA[
    	SELECT
			(SELECT
                   SUM(WD.BX_QNTT) AS BX_QNTT
                 FROM TB_WGH_PRFMNC_COM WC
                    , TB_WGH_PRFMNC_DTL WD
                WHERE WC.APC_CD = WD.APC_CD
                  AND WC.WGHNO = WD.WGHNO
                  AND WC.DEL_YN = 'N'
                  AND WD.DEL_YN = 'N'
                  AND WC.WRHS_SPMT_TYPE = 'RT'
		      ]]>
			      <if test='apcCd != null and apcCd != ""'>
		               AND WC.APC_CD = #{apcCd}
				</if>
				<if test='wghYmdFrom != null and wghYmdFrom != ""'>
	 			    AND WC.WGH_YMD <![CDATA[>=]]> #{wghYmdFrom}
				</if>
				<if test='wghYmdTo != null and wghYmdTo != ""'>
	 				AND WC.WGH_YMD <![CDATA[<=]]> #{wghYmdTo}
				</if>
			    GROUP BY WC.APC_CD,WC.WRHS_SPMT_TYPE) -
			    (SELECT
                   SUM(WD.BX_QNTT) AS BX_QNTT
                 FROM TB_WGH_PRFMNC_COM WC
                    , TB_WGH_PRFMNC_DTL WD
                WHERE WC.APC_CD = WD.APC_CD
                  AND WC.WGHNO = WD.WGHNO
                  AND WC.DEL_YN = 'N'
                  AND WD.DEL_YN = 'N'
                  AND WC.WRHS_SPMT_TYPE = 'DT'

			      <if test='apcCd != null and apcCd != ""'>
		               AND WC.APC_CD = #{apcCd}
				</if>
				<if test='wghYmdFrom != null and wghYmdFrom != ""'>
	 			    AND WC.WGH_YMD <![CDATA[>=]]> #{wghYmdFrom}
				</if>
				<if test='wghYmdTo != null and wghYmdTo != ""'>
	 				AND WC.WGH_YMD <![CDATA[<=]]> #{wghYmdTo}
				</if>
			    GROUP BY WC.APC_CD,WC.WRHS_SPMT_TYPE) AS TOT_INVNTR_QNTT
		  FROM DUAL
    </select>

    <!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.am.clcln.mapper.ClclnWkrptMapper.selectWkrptLastQnttList	-->
	<!-- DESC : 전재고 조회 			                        	            	-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2025.02.20  	박승진        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <select id="selectClclnNowInvntrList" parameterType="com.at.apcss.am.clcln.vo.ClclnNowInvntrVO" resultType="com.at.apcss.am.clcln.vo.ClclnNowInvntrVO">
		<![CDATA[
    	SELECT
			#{apcCd} AS APC_CD
			, #{crtrYmd} AS CRTR_YMD
			, CASE
				WHEN CUR.TOT_INVNTR_QNTT IS NOT NULL THEN CUR.TOT_INVNTR_QNTT
				ELSE PREV.NOW_INVNTR_QNTT
			  END AS LAST_WKND_QNTT
			, CUR.NOW_INVNTR_QNTT AS NOW_INVNTR_QNTT
   		FROM DUAL
   			LEFT OUTER JOIN TB_CLCLN_NOW_INVNTR CUR
   				ON CUR.CRTR_YMD = #{crtrYmd}
   				AND CUR.DEL_YN = 'N'
   			LEFT OUTER JOIN TB_CLCLN_NOW_INVNTR PREV
   				ON PREV.CRTR_YMD = TO_CHAR(TO_DATE(#{crtrYmd}, 'YYYYMMDD') - 7, 'YYYYMMDD')
   				AND PREV.DEL_YN = 'N'
		]]>
    </select>

     <!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.am.clcln.mapper.ClclnWkrptMapper.insertClclnNowInvntr	-->
	<!-- DESC : 전재고 등록 			                        	            	-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2025.02.20  	박승진        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <insert id="insertClclnNowInvntr" parameterType="com.at.apcss.am.clcln.vo.ClclnNowInvntrVO">
		INSERT INTO TB_CLCLN_NOW_INVNTR
			(
				APC_CD
				, CRTR_YMD
				, WRHS_QNTT
				, SPMT_QNTT
				, TOT_INVNTR_QNTT
				, NOW_INVNTR_QNTT
				, LS_QNTT
				, DEL_YN
				, SYS_FRST_INPT_DT
				, SYS_FRST_INPT_USER_ID
				, SYS_FRST_INPT_PRGRM_ID
				, SYS_LAST_CHG_DT
				, SYS_LAST_CHG_USER_ID
				, SYS_LAST_CHG_PRGRM_ID

			)
			VALUES(
				#{apcCd}
				, #{crtrYmd}
				, #{wrhsQntt}
				, #{spmtQntt}
				, #{totInvntrQntt}
				, #{nowInvntrQntt}
				, #{lsQntt}
				, 'N'
				, SYSDATE
				, #{sysFrstInptUserId}
				, #{sysFrstInptPrgrmId}
				, SYSDATE
				, #{sysLastChgUserId}
				, #{sysLastChgPrgrmId}
			)
    </insert>


      <!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.am.clcln.mapper.ClclnWkrptMapper.updateClclnNowInvntr	-->
	<!-- DESC : 전재고 수정 			                        	            	-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2025.02.20  	박승진        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <update id="updateClclnNowInvntr" parameterType="com.at.apcss.am.clcln.vo.ClclnNowInvntrVO">
		UPDATE TB_CLCLN_NOW_INVNTR SET
			WRHS_QNTT = #{wrhsQntt}
			, SPMT_QNTT = #{spmtQntt}
		    , TOT_INVNTR_QNTT = #{totInvntrQntt}
			, NOW_INVNTR_QNTT = #{nowInvntrQntt}
		    , LS_QNTT = #{lsQntt}
			, SYS_LAST_CHG_DT = SYSDATE
		WHERE APC_CD = #{apcCd}
		  AND CRTR_YMD = #{crtrYmd}
    </update>



</mapper>


