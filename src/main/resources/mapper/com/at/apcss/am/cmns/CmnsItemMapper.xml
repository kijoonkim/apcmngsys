<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- ==========================================================================	-->
<!-- NAME : CmnsItemMapper.xml                                   				-->
<!-- DESC : 품목 mapper                                             			-->
<!-- ==========================================================================	-->
<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
<!-- ===========  	============  	===========================================	-->
<!-- 2023.07.14  	김 호        	Initial Creation                            -->
<!-- ==========================================================================	-->

<mapper namespace="com.at.apcss.am.cmns.mapper.CmnsItemMapper">

	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.am.cmns.mapper.CmnsItemMapper.selectCmnsApcItem		-->
	<!-- DESC : APC 품목 단건 조회.	                                       			-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.09.05  	김 호        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <select id="selectCmnsApcItem" parameterType="com.at.apcss.am.cmns.vo.CmnsItemVO" resultType="com.at.apcss.am.cmns.vo.CmnsItemVO">
    	<![CDATA[
	    	SELECT  /* com.at.apcss.am.cmns.mapper.CmnsItemMapper.selectCmnsApcItem */
			       AIC.APC_CD           AS APC_CD
			     , AIC.ITEM_CD          AS ITEM_CD
			     , AIC.ITEM_NM          AS ITEM_NM
			     , AIC.RAW_MTR_RDCD_RT  AS RAW_MTR_RDCD_RT
			     , AIC.SORT_RDCD_RT     AS SORT_RDCD_RT
			     , AIC.PCKG_RDCD_RT     AS PCKG_RDCD_RT
			     , AIC.DEL_YN           AS DEL_YN
			     , AIC.NH_APC_CD        AS NH_APC_CD
			     , AIC.NH_ITEM_NM       AS NH_ITEM_NM
			  FROM TB_APC_ITEM_CRTR AIC
			 WHERE AIC.APC_CD = #{apcCd}
			   AND AIC.ITEM_CD = #{itemCd}
		]]>
    </select>

	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.am.cmns.mapper.CmnsItemMapper.selectCmnsItemList		-->
	<!-- DESC : 품목 전체 목록 조회.	                                       		-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.07.13  	김 호        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <select id="selectCmnsItemList" parameterType="com.at.apcss.am.cmns.vo.CmnsItemVO" resultType="com.at.apcss.am.cmns.vo.CmnsItemVO">
    	<![CDATA[
	    	SELECT /*  com.at.apcss.am.cmns.mapper.CmnsItemMapper.selectCmnsItemList */
	    		   (SELECT FN_GET_COM_CD_VL_NM('CLS_CD', SUBSTR(IC.ITEM_CD, 0, 2)) FROM DUAL) AS CLS_NM
	    		 , IC.ITEM_CD
			     , IC.ITEM_NM
			     , IC.DEL_YN
			  FROM TB_ITEM_CRTR IC
			 WHERE IC.DEL_YN = 'N'
		]]>
			<if test='itemCd != null and itemCd != ""'>
			  AND IC.ITEM_CD LIKE #{itemCd} || '%'
			</if>
			<if test='itemNm != null and itemNm != ""'>
			  AND IC.ITEM_NM LIKE '%' || #{itemNm} || '%'
			</if>
			<if test='apcCd != null and apcCd != ""'>
			  AND NOT EXISTS (
                    SELECT 1
                      FROM TB_APC_ITEM_CRTR X
                     WHERE X.APC_CD = #{apcCd}
                       AND X.ITEM_CD = IC.ITEM_CD
                  )
			</if>
		<![CDATA[
			ORDER BY IC.ITEM_CD
		]]>
    </select>

	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.am.cmns.mapper.CmnsItemMapper.selectApcCmnsItemList	-->
	<!-- DESC : APC 품목 전체 목록 조회.	                                       	-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.07.13  	김 호        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <select id="selectApcCmnsItemList" parameterType="com.at.apcss.am.cmns.vo.CmnsItemVO" resultType="com.at.apcss.am.cmns.vo.CmnsItemVO">
    	<![CDATA[
	    	SELECT /* com.at.apcss.am.cmns.mapper.CmnsItemMapper.selectApcCmnsItemList */
	    		  AIC.APC_CD						AS APC_CD
			    , AIC.ITEM_CD						AS ITEM_CD
			    , AIC.ITEM_NM						AS ITEM_NM
			    , AIC.DEL_YN						AS DEL_YN
			    , AIC.RAW_MTR_RDCD_RT				AS RAW_MTR_RDCD_RT
			    , AIC.SORT_RDCD_RT					AS SORT_RDCD_RT
			    , AIC.PCKG_RDCD_RT					AS PCKG_RDCD_RT
	    	    , AIC.EXTRNL_LNKG_CD				AS EXTRNL_LNKG_CD
	    	    , AIC.HSTRY_TRC_MNG_NO				AS HSTRY_TRC_MNG_NO
			    , AIC.GAP_CERT_NO					AS GAP_CERT_NO
			    , (SELECT COUNT(*) FROM TB_APC_VRTY_CRTR X WHERE X.APC_CD = AIC.APC_CD AND X.ITEM_CD = AIC.ITEM_CD AND X.DEL_YN = 'N') AS VRTR_CNT
			    , (SELECT COUNT(*) FROM TB_APC_SPCFCT_CRTR X WHERE X.APC_CD = AIC.APC_CD AND X.ITEM_CD = AIC.ITEM_CD AND X.DEL_YN = 'N') AS SPCFCT_CNT
			    , (SELECT COUNT(*) FROM TB_APC_STD_GRD X WHERE APC_CD = AIC.APC_CD AND X.ITEM_CD = AIC.ITEM_CD AND X.DEL_YN = 'N') AS GRD_CNT
			  FROM TB_APC_ITEM_CRTR AIC
			 WHERE AIC.DEL_YN = 'N'
			   AND AIC.APC_CD = #{apcCd}

		]]>
		<if test='extrnlLnkgCd != null and extrnlLnkgCd != ""'>
		  	  AND AIC.EXTRNL_LNKG_CD = #{extrnlLnkgCd}
		</if>
		<![CDATA[
			ORDER BY AIC.ITEM_CD
		]]>
    </select>

    <!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.am.cmns.mapper.CmnsItemMapper.insertCmnsItem			-->
	<!-- DESC : 품목 등록.	                                       					-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.07.13  	김 호        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <insert id="insertCmnsItem" parameterType="com.at.apcss.am.cmns.vo.CmnsItemVO">
    	<![CDATA[
    		INSERT /* com.at.apcss.am.cmns.mapper.CmnsItemMapper.insertCmnsItem */
    			INTO TB_APC_ITEM_CRTR
	    		(
	    			  APC_CD
	    		  	, ITEM_CD
	    		  	, ITEM_NM
	    		  	, SYS_FRST_INPT_DT
	    		  	, SYS_FRST_INPT_USER_ID
	    		  	, SYS_FRST_INPT_PRGRM_ID
	    		  	, SYS_LAST_CHG_DT
	    		  	, SYS_LAST_CHG_USER_ID
	    		  	, SYS_LAST_CHG_PRGRM_ID
	    		)
   			VALUES
	   			(
	   				  #{apcCd}
	    		  	, #{itemCd}
	    		  	, #{itemNm}
	    		  	, SYSDATE
	    		  	, #{sysFrstInptUserId}
	    		  	, #{sysFrstInptPrgrmId}
	    		  	, SYSDATE
	    		  	, #{sysLastChgUserId}
	    		  	, #{sysLastChgPrgrmId}
	   			)
    	]]>
    </insert>

    <!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.am.cmns.mapper.CmnsItemMapper.updateCmnsItem			-->
	<!-- DESC : 품목 변경.	                                       					-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.07.13  	김 호        	Initial Creation                            -->
	<!-- ==========================================================================	-->
	<update id="updateApcCmnsItem" parameterType="com.at.apcss.am.cmns.vo.CmnsItemVO">
		<![CDATA[
			UPDATE
				TB_APC_ITEM_CRTR
			   SET
			   	  SYS_LAST_CHG_DT		= SYSDATE
	    		, SYS_LAST_CHG_USER_ID	= #{sysLastChgUserId}
	    		, SYS_LAST_CHG_PRGRM_ID = #{sysLastChgPrgrmId}
				, RAW_MTR_RDCD_RT		= #{rawMtrRdcdRt}
	    		, SORT_RDCD_RT			= #{sortRdcdRt}
	    		, PCKG_RDCD_RT			= #{pckgRdcdRt}
			    , EXTRNL_LNKG_CD		= #{extrnlLnkgCd}
			    , HSTRY_TRC_MNG_NO		= #{hstryTrcMngNo}
			    , GAP_CERT_NO			= #{gapCertNo}
			 WHERE APC_CD 		= #{apcCd}
			   AND ITEM_CD		= #{itemCd}
		]]>
	</update>

	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.am.cmns.mapper.CnptMapper.deleteCmnsItem				-->
	<!-- DESC : 품목 삭제.	                                       					-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.07.13  	김 호        	Initial Creation                            -->
	<!-- ==========================================================================	-->
	<delete id="deleteCmnsItem" parameterType="com.at.apcss.am.cmns.vo.CmnsItemVO">
		<![CDATA[
			DELETE /* com.at.apcss.am.cmns.mapper.CnptMapper.deleteCmnsItem */
				FROM TB_APC_ITEM_CRTR
			 WHERE APC_CD		= #{apcCd}
			   AND ITEM_CD 		= #{itemCd}
		]]>
	</delete>

	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.am.cmns.mapper.CmnsItemMapper.itemDelible				-->
	<!-- DESC : APC 품목 삭제 가능 여부.	                                       	-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2024.01.24  	김 호        	Initial Creation                           	-->
	<!-- ==========================================================================	-->
    <select id="itemDelible" parameterType="com.at.apcss.am.cmns.vo.CmnsItemVO" resultType="com.at.apcss.am.cmns.vo.CmnsItemVO">
    	<![CDATA[
    		SELECT X.* /* com.at.apcss.am.cmns.mapper.CmnsItemMapper.itemDelible */
			  FROM (
			         SELECT
			                '입고실적' AS DELIBLE
			               , (SELECT COUNT(*)
			                    FROM TB_RAW_MTR_WRHS_PRFMNC X
			                       , TB_RAW_MTR_INVNTR Y
			                   WHERE X.APC_CD = Y.APC_CD
			                     AND X.WRHSNO = Y.WRHSNO
			                     AND X.APC_CD = #{apcCd}
			                     AND Y.ITEM_CD = #{itemCd}
			                     AND X.DEL_YN = 'N'
			                     AND Y.DEL_YN = 'N'
			                  )  AS CNT
			           FROM DUAL
			         UNION ALL
			         SELECT
			                '원물재고' AS DELIBLE
			                , (SELECT COUNT(*)
			                    FROM TB_RAW_MTR_INVNTR X
			                   WHERE X.APC_CD = #{apcCd}
			                     AND X.ITEM_CD = #{itemCd}
			                     AND X.DEL_YN = 'N'
			                  )  AS CNT
			           FROM DUAL
			         UNION ALL
			         SELECT
			                '선별실적' AS DELIBLE
			               , (SELECT COUNT(*)
			                    FROM TB_SORT_PRFMNC X
			                       , TB_SORT_INVNTR Y
			                   WHERE X.APC_CD = Y.APC_CD
			                     AND X.SORTNO = Y.SORTNO
			                     AND X.APC_CD = #{apcCd}
			                     AND Y.ITEM_CD = #{itemCd}
			                     AND X.DEL_YN = 'N'
			                     AND Y.DEL_YN = 'N'
			                  )  AS CNT
			           FROM DUAL
			         UNION ALL
			         SELECT
			                '선별재고' AS DELIBLE
			                , (SELECT COUNT(*)
			                    FROM TB_SORT_INVNTR X
			                   WHERE X.APC_CD = #{apcCd}
			                     AND X.ITEM_CD = #{itemCd}
			                     AND X.DEL_YN = 'N'
			                  )  AS CNT
			           FROM DUAL
			          UNION ALL
			          SELECT
			                '포장지시' AS DELIBLE
			               , (SELECT COUNT(*)
			                    FROM TB_PCKG_CMND X
			                   WHERE X.APC_CD = #{apcCd}
			                     AND X.ITEM_CD = #{itemCd}
			                     AND X.DEL_YN = 'N'
			                  )  AS CNT
			            FROM DUAL
			          UNION ALL
			          SELECT
			                 '포장실적' AS DELIBLE
			                 , (SELECT COUNT(*)
			                     FROM TB_PCKG_PRFMNC X
			                        , TB_GDS_INVNTR Y
			                    WHERE X.APC_CD = Y.APC_CD
			                      AND X.PCKGNO = Y.PCKGNO
			                      AND X.APC_CD = #{apcCd}
			                      AND Y.ITEM_CD = #{itemCd}
			                      AND X.DEL_YN = 'N'
			                      AND Y.DEL_YN = 'N'
			                  )  AS CNT
			            FROM DUAL
			          UNION ALL
			          SELECT
			                 '상품재고' AS DELIBLE
			                , (SELECT COUNT(*)
			                     FROM TB_GDS_INVNTR X
			                    WHERE X.APC_CD = #{apcCd}
			                      AND X.ITEM_CD = #{itemCd}
			                      AND X.DEL_YN = 'N'
			                 )  AS CNT
			             FROM DUAL
			           UNION ALL
			           SELECT
			                  '상품' AS DELIBLE
			                 , (SELECT COUNT(*)
			                      FROM TB_SPMT_PCKG_UNIT X
			                     WHERE X.APC_CD = #{apcCd}
			                       AND X.ITEM_CD = #{itemCd}
			                       AND X.DEL_YN = 'N'
			                  )  AS CNT
			             FROM DUAL
			           UNION ALL
			           SELECT
			                  '출하지시' AS DELIBLE
			                 , (SELECT COUNT(*)
			                      FROM TB_SPMT_CMND X
			                     WHERE X.APC_CD = #{apcCd}
			                       AND X.ITEM_CD = #{itemCd}
			                       AND X.DEL_YN = 'N'
			                  )  AS CNT
			             FROM DUAL
			           UNION ALL
			           SELECT
			                   '출하실적' AS DELIBLE
			                  , (SELECT COUNT(*)
			                       FROM TB_SPMT_PRFMNC_DTL X
			                      WHERE X.APC_CD = #{apcCd}
			                        AND X.ITEM_CD = #{itemCd}
			                        AND X.DEL_YN = 'N'
			                   )  AS CNT
			             FROM DUAL
			           UNION ALL
			           SELECT
			                  '매출실적' AS DELIBLE
			                 , (SELECT COUNT(*)
			                      FROM TB_SLS_PRFMNC X
			                     WHERE X.APC_CD = #{apcCd}
			                       AND X.ITEM_CD = #{itemCd}
			                       AND X.DEL_YN = 'N'
			                  )  AS CNT
			             FROM DUAL
			           UNION ALL
			           SELECT
			                  '정산단가' AS DELIBLE
			                 , (SELECT COUNT(*)
			                      FROM TB_CLCLN_UNTPRC X
			                     WHERE X.APC_CD = #{apcCd}
			                       AND X.ITEM_CD = #{itemCd}
			                       AND X.DEL_YN = 'N'
			                  )  AS CNT
			            FROM DUAL
			           UNION ALL
			           SELECT
			                  '정산실적' AS DELIBLE
			                 , (SELECT COUNT(*)
			                      FROM TB_CLCLN_PRFMNC X
			                     WHERE X.APC_CD = #{apcCd}
			                       AND X.ITEM_CD = #{itemCd}
			                       AND X.DEL_YN = 'N'
			                  )  AS CNT
			            FROM DUAL
			         ) X
			 WHERE CNT > 0
		]]>
    </select>

    <!-- =========================================================================  -->
	<!-- NAME : com.at.apcss.am.cmns.mapper.CmnsItemMapper.updateComItem			-->
	<!-- DESC : APC기준 품목 정보 업데이트  		                            				-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2024.04.05  	kimho        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <update id="updateComItem" parameterType="com.at.apcss.am.cmns.vo.CmnsItemVO">
    	<![CDATA[
    	   UPDATE TB_APC_ITEM_CRTR
		      SET SYS_LAST_CHG_DT = SYSDATE
		   		, SYS_LAST_CHG_USER_ID=#{sysLastChgUserId}
		   		, SYS_LAST_CHG_PRGRM_ID=#{sysLastChgPrgrmId}
		   		, EXTRNL_LNKG_CD=#{extrnlLnkgCd}
		   WHERE APC_CD=#{apcCd}
		     AND ITEM_CD=#{itemCd}
    	]]>
    </update>
	<!-- =========================================================================  -->
	<!-- NAME : com.at.apcss.am.cmns.mapper.CmnsItemMapper.selectApcBffaTypeList	-->
	<!-- DESC : APC기준 육안선별 타입 조회  		                            		-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2024.04.22  	손민성        	Initial Creation                            -->
	<!-- ==========================================================================	-->
	<select id="selectApcBffaTypeList" parameterType="com.at.apcss.am.cmns.vo.CmnsItemVO" resultType="com.at.apcss.co.cd.vo.ComCdVO">
		<![CDATA[
		SELECT
			GT.CD_VL AS CD_VL
		  , GT.CD_VL_NM AS CD_VL_NM
		  , ROW_NUMBER() OVER (ORDER BY GT.INDCT_SEQ)AS SN
		FROM TB_COM_CD_DTL GT
		WHERE GT.CD_ID = 'BFFA_GRD_TYPE'
		  AND GT.DEL_YN = 'N'
		  AND GT.APC_CD = #{apcCd}
		  AND EXISTS (
		      SELECT 1
		      FROM TB_APC_BFFA_GRD_KND GK
		      WHERE GK.APC_CD = GT.APC_CD
		      AND GK.BFFA_GRD_TYPE = GT.CD_VL
			  AND GK.DEL_YN = 'N'
			  AND GK.ITEM_CD = #{itemCd}
		      )
		ORDER BY SN
		]]>

	</select>
	<!-- =========================================================================  -->
	<!-- NAME : com.at.apcss.am.cmns.mapper.CmnsItemMapper.selectApcBffaTypeList	-->
	<!-- DESC : APC기준 육안선별 타입 조회  		                            		-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2024.04.22  	손민성        	Initial Creation                            -->
	<!-- ==========================================================================	-->
	<select id="selectApcBffaGrdDtlList" parameterType="com.at.apcss.am.sort.vo.SortBffaGrdVO" resultType="com.at.apcss.am.sort.vo.SortBffaGrdVO">
		<![CDATA[
		SELECT
			   GT.CD_VL AS CD_VL
			 , GT.CD_VL_NM AS CD_VL_NM
			 , GT.INDCT_SEQ AS INDCT_SEQ
			 , GK.ITEM_CD AS ITEM_CD
			 , GK.BFFA_GRD_TYPE AS BFFA_GRD_TYPE
			 , COUNT(GK.GRD_KND) OVER (PARTITION BY GT.CD_VL) AS GRD_KND_CNT
			 , GK.GRD_KND AS GRD_KND
			 , GK.GRD_KND_NM AS GRD_KND_NM
			 , GK.SN AS GRD_KND_SN
			 , COUNT(GD.GRD_CD) OVER (PARTITION BY GK.GRD_KND) AS GRD_CD_CNT
			 , GD.GRD_CD AS GRD_CD
			 , GD.GRD_NM AS GRD_NM
			 , GD.SN AS GRD_CD_SN
			 , ROW_NUMBER() OVER (ORDER BY GT.INDCT_SEQ, GT.CD_VL, GK.SN, GK.GRD_KND, GD.SN, GD.GRD_CD) AS CHECK_INDEX
		FROM TB_COM_CD_DTL GT
		JOIN TB_APC_BFFA_GRD_KND GK
			ON GK.APC_CD = GT.APC_CD
			AND GK.BFFA_GRD_TYPE = GT.CD_VL
			AND GK.DEL_YN = 'N'
		LEFT JOIN TB_APC_BFFA_GRD_DTL GD
		    ON GD.APC_CD = GK.APC_CD
			AND GD.BFFA_GRD_TYPE = GK.BFFA_GRD_TYPE
			AND GD.ITEM_CD = GK.ITEM_CD
			AND GD.GRD_KND = GK.GRD_KND
			AND GD.DEL_YN = 'N'
		WHERE GT.CD_ID = 'BFFA_GRD_TYPE'
		  	AND GT.DEL_YN = 'N'
		  	AND GT.APC_CD = #{apcCd}
		  	AND GK.ITEM_CD = #{itemCd}
		ORDER BY ITEM_CD, INDCT_SEQ, GRD_KND_SN, GRD_CD_SN;
		]]>
	</select>
	<!-- =========================================================================  -->
	<!-- NAME : com.at.apcss.am.cmns.mapper.CmnsItemMapper.selectBffaGrdKndList	    -->
	<!-- DESC : APC기준 육안선별 타입선택 checkbox 조회                           		-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2024.04.26  	손민성        	Initial Creation                            -->
	<!-- ==========================================================================	-->
	<select id="selectBffaGrdKndList" parameterType="com.at.apcss.am.sort.vo.SortBffaWrhsStdGrdVO" resultType="com.at.apcss.am.sort.vo.SortBffaWrhsStdGrdVO">
		<![CDATA[
		SELECT
			GRD.APC_CD
			 ,GRD.BFFA_WRHSNO
			 ,GRD.BFFA_GRD_TYPE
			 ,GRD.ITEM_CD
			 ,GRD.GRD_KND
			 ,GRD.GRD_CD
			 ,GRD.GRD_NV
			 ,GRD.GRD_QNTT
			 ,GRD.GRD_WGHT
			 ,GKD.CHECK_INDEX
		FROM
			TB_BFFA_WRHS_STD_GRD AS GRD
				LEFT JOIN(
				SELECT
					GT.APC_CD  AS APC_CD
					 , GT.CD_VL AS CD_VL
					 , GT.CD_VL_NM AS CD_VL_NM
					 , GT.INDCT_SEQ AS INDCT_SEQ
					 , GK.ITEM_CD AS ITEM_CD
					 , GK.BFFA_GRD_TYPE AS BFFA_GRD_TYPE
					 , COUNT(GK.GRD_KND) OVER (PARTITION BY GT.CD_VL) AS GRD_KND_CNT
					, GK.GRD_KND AS GRD_KND
					 , GK.GRD_KND_NM AS GRD_KND_NM
					 , GK.SN AS GRD_KND_SN
					 , COUNT(GD.GRD_CD) OVER (PARTITION BY GK.GRD_KND) AS GRD_CD_CNT
					, TO_NUMBER(GD.GRD_CD) AS GRD_CD
					 , GD.GRD_NM AS GRD_NM
					 , GD.SN AS GRD_CD_SN
					 , ROW_NUMBER() OVER (ORDER BY GT.INDCT_SEQ, GT.CD_VL, GK.SN, GK.GRD_KND, GD.SN, GD.GRD_CD) AS CHECK_INDEX
				FROM TB_COM_CD_DTL GT
				JOIN TB_APC_BFFA_GRD_KND GK
						  ON GK.APC_CD = GT.APC_CD
						  AND GK.BFFA_GRD_TYPE = GT.CD_VL
						  AND GK.DEL_YN = 'N'
				LEFT JOIN TB_APC_BFFA_GRD_DTL GD
						 ON GD.APC_CD = GK.APC_CD
						 AND GD.BFFA_GRD_TYPE = GK.BFFA_GRD_TYPE
						 AND GD.ITEM_CD = GK.ITEM_CD
						 AND GD.GRD_KND = GK.GRD_KND
						 AND GD.DEL_YN = 'N'
				WHERE GT.CD_ID = 'BFFA_GRD_TYPE'
				AND GT.DEL_YN = 'N'
				AND GT.APC_CD =#{apcCd}
				AND GK.ITEM_CD = #{itemCd}
				ORDER BY ITEM_CD, INDCT_SEQ, GRD_KND_SN, GRD_CD_SN
				) AS GKD
				 ON GRD.BFFA_GRD_TYPE = GKD.BFFA_GRD_TYPE
				 AND GRD.ITEM_CD = GKD.ITEM_CD
				 AND GRD.GRD_KND = GKD.GRD_KND
				 AND GRD.GRD_CD = GKD.GRD_CD
				 AND GRD.APC_CD = #{apcCd}
				 AND BFFA_WRHSNO = #{bffaWrhsno}
	]]>
	</select>
</mapper>


