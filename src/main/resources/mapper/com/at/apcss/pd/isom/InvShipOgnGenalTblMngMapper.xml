<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- ==========================================================================	-->
<!-- NAME : BbsMapper.xml                                    				-->
<!-- DESC : 게시판 정보 mapper                                             			-->
<!-- ==========================================================================	-->
<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
<!-- ===========  	============  	===========================================	-->
<!-- 2023.06.29  	jcshin        	Initial Creation                            -->
<!-- ==========================================================================	-->

<mapper namespace="com.at.apcss.pd.isom.mapper.InvShipOgnGenalTblMngMapper">

	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.fm.bbs.mapper.BbsMngMapper.selectBbs				-->
	<!-- DESC : 게시판 테이블 단건조회.                                             		-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.06.29  	jcshin        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <select id="selectInvShipOgnGenalTblMng" parameterType="com.at.apcss.pd.isom.vo.InvShipOgnGenalTblMngVO" resultType="com.at.apcss.pd.isom.vo.InvShipOgnGenalTblMngVO">
		SELECT /* com.at.apcss.pd.isom.mapper.InvShipOgnGenalTblMngMapper.selectInvShipOgnGenalTblMng */
			'a' as BRNO
		FROM DUAL
		WHERE 1=1
    </select>


	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.fm.bbs.mapper.BbsMngMapper.selectBbsList			-->
	<!-- DESC : 게시판 테이블 목록 조회.                                             		-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.06.29  	jcshin        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <select id="selectInvShipOgnGenalTblMngList" parameterType="com.at.apcss.pd.isom.vo.InvShipOgnGenalTblMngVO" resultType="com.at.apcss.pd.isom.vo.InvShipOgnGenalTblMngVO">
			SELECT	/* com.at.apcss.pd.isom.mapper.InvShipOgnSpeczItmPurSalMngMapper.selectItemStbltYn */
			TOTAL.ITEM_CD
			,TOTAL.ITEM_NM
			,TOTAL.STTG_UPBR_ITEM_SE
			,TOTAL.STTG_UPBR_ITEM_NM
			,TOTAL.CTGRY_CD
			,TOTAL.CTGRY_NM
			,TOTAL.BRNO
			,TOTAL.UO_BRNO
			,TOTAL.YR
			,TOTAL.APRV
			,(SELECT CD_VL_NM FROM TB_COM_CD_DTL WHERE CD_ID = 'APRV_UPBR_SE_CD' AND CD_VL = TOTAL.APRV) AS APRV_NM
			,TOTAL.CORP_NM
			,TOTAL.UO_SPMT_AMT
			,TOTAL.UO_SPMT_AMT_OTHER
			,TOTAL.UO_OTHER_SPMT_AMT
			,TOTAL.UO_OTHER_SPMT_AMT_OTHER
			,TOTAL.UO_SPMT_AMT_TOT
			,TOTAL.UO_SPMT_AMT_RT
			,TOTAL.UO_SPMT_AMT_TOT_RT

			,TOTAL.CHK_A_A
			,TOTAL.CHK_A_B
			,TOTAL.CHK_A_C

			,TOTAL.CHK_B_A
			,TOTAL.CHK_B_B
			,TOTAL.CHK_B_C
			, (CASE WHEN TOTAL.APRV = '1' AND STTG_UPBR_ITEM_SE = '1' THEN
																(CASE WHEN  TOTAL.CHK_A_A = 'Y' AND TOTAL.CHK_A_B = 'Y' AND TOTAL.CHK_A_C = 'Y'
																			THEN 'Y'
																			ELSE 'N' END)
					WHEN TOTAL.APRV = '1' AND STTG_UPBR_ITEM_SE = '2' THEN 'Y'
					WHEN  TOTAL.APRV = '2' THEN
																(CASE WHEN  TOTAL.CHK_B_A = 'Y' AND TOTAL.CHK_B_B = 'Y' AND TOTAL.CHK_B_C = 'Y'
																			THEN 'Y'
																			ELSE 'N' END)
					ELSE 'N' END
			) AS STBLT_YN

		FROM
				(SELECT
					TOT.ITEM_CD
					,TOT.ITEM_NM
					,TOT.STTG_UPBR_ITEM_SE
					,TOT.STTG_UPBR_ITEM_NM
					,TOT.CTGRY_CD
					,TOT.CTGRY_NM
					,TOT.BRNO
					,TOT.UO_BRNO
					,TOT.YR
					,TOT.APRV
					,(SELECT CD_VL_NM FROM TB_COM_CD_DTL WHERE CD_ID = 'APRV_UPBR_SE_CD' AND CD_VL = TOT.APRV) AS APRV_NM
					,TOT.CORP_NM
					,TOT.UO_SPMT_AMT
					,TOT.UO_SPMT_AMT_OTHER
					,TOT.UO_OTHER_SPMT_AMT
					,TOT.UO_OTHER_SPMT_AMT_OTHER
					,TOT.UO_SPMT_AMT_TOT
					,TOT.UO_SPMT_AMT_RT
					,TOT.UO_SPMT_AMT_TOT_RT

					,(CASE WHEN TOT.UO_SPMT_AMT >= 500000 THEN 'Y' ELSE 'N' END) AS CHK_A_A
					,(CASE WHEN TOT.UO_SPMT_AMT_RT >= 60 THEN 'Y' ELSE 'N' END) AS CHK_A_B
					,(CASE WHEN TOT.UO_SPMT_AMT_RT >= 60 THEN 'Y' ELSE 'N' END) AS CHK_A_C

					,(CASE WHEN TOT.UO_SPMT_AMT >= 300000 THEN 'Y' ELSE 'N' END) AS CHK_B_A
					,(CASE WHEN TOT.UO_SPMT_AMT_RT >= 100 THEN 'Y' ELSE 'N' END) AS CHK_B_B
					,(CASE WHEN TOT.UO_SPMT_AMT_RT >=  20 THEN 'Y' ELSE 'N' END) AS CHK_B_C
				FROM
					(SELECT
							ITEM.ITEM_CD
							, ITEM.ITEM_NM
							, ITEM.STTG_UPBR_ITEM_SE
							, ITEM.STTG_UPBR_ITEM_NM
							, ITEM.CTGRY_CD
							, ITEM.CTGRY_NM
							, ITEM.BRNO
							, ITEM.UO_BRNO
							, ITEM.YR
							, (SELECT APRV FROM TB_EV_APO WHERE BRNO = ITEM.UO_BRNO) AS APRV
							, (SELECT CORP_NM FROM TB_EV_APO WHERE BRNO = ITEM.BRNO) AS CORP_NM

							, TOTA.UO_SPMT_AMT 	AS UO_SPMT_AMT
							, TOTB.UO_SPMT_AMT 	AS UO_SPMT_AMT_OTHER

							, TOTA.UO_OTHER_SPMT_AMT 	AS UO_OTHER_SPMT_AMT
							, TOTB.UO_OTHER_SPMT_AMT 	AS UO_OTHER_SPMT_AMT_OTHER

							, (TOTA.UO_SPMT_AMT + TOTA.UO_OTHER_SPMT_AMT + TOTB.UO_SPMT_AMT + TOTB.UO_OTHER_SPMT_AMT) AS UO_SPMT_AMT_TOT

							, ROUND(NVL( TOTA.UO_SPMT_AMT / NULLIF( TOTA.UO_SPMT_AMT + TOTB.UO_SPMT_AMT , 0 ) , 0 ) * 100 , 2 ) AS UO_SPMT_AMT_RT
							, ROUND(NVL( (TOTA.UO_SPMT_AMT + TOTA.UO_OTHER_SPMT_AMT) / NULLIF( TOTA.UO_SPMT_AMT + TOTA.UO_OTHER_SPMT_AMT + TOTB.UO_SPMT_AMT + TOTB.UO_OTHER_SPMT_AMT, 0 ) , 0 ) * 100 , 2) AS UO_SPMT_AMT_TOT_RT
						FROM
							(SELECT
									ITEM_CD
									, YR
									, STTG_UPBR_ITEM_SE
									, CTGRY_CD
									, TO_CHAR(BRNO) AS UO_BRNO
									, #{brno} AS BRNO
									,(SELECT ITEM_NM FROM TB_ITEM_CRTR WHERE ITEM_CD = AYGC.ITEM_CD) AS ITEM_NM
									,(SELECT CD_VL_NM FROM TB_COM_CD_DTL WHERE CD_ID = 'CTGRY_CD' AND CD_VL = AYGC.CTGRY_CD) AS CTGRY_NM
									,(SELECT CD_VL_NM FROM TB_COM_CD_DTL WHERE CD_ID = 'STTG_UPBR_ITEM_SE' AND CD_VL = AYGC.STTG_UPBR_ITEM_SE) AS STTG_UPBR_ITEM_NM
								FROM TB_EV_APO_YR_GPC_CD AYGC
								WHERE 1=1
								<if test='uoBrno != null and uoBrno != ""'>
							  	  AND BRNO = #{uoBrno}
							  	</if>
							  	<if test='yr != null and yr != ""'>
							  	  AND YR = #{yr}
							  	</if>
							) ITEM ,
							(SELECT
									BRNO
									, ITEM_CD
									, SUM( NVL( UO_SPMT_AMT , 0 ) ) AS UO_SPMT_AMT
									, SUM( NVL( UO_OTHER_SPMT_AMT , 0 ) ) AS UO_OTHER_SPMT_AMT
								FROM TB_EV_UO_ISO_PRCHS_PRCHS_SLS_TOT
								WHERE 1=1
								AND APO_SE = '2'
								AND TYPE_SE_NO IN ('5')

								<if test='uoBrno != null and uoBrno != ""'>
							  	  AND UO_BRNO = #{uoBrno}
							  	</if>
							  	<if test='brno != null and brno != ""'>
							  	  AND BRNO = #{brno}
							  	</if>
							  	<if test='yr != null and yr != ""'>
							  	  AND YR = #{yr}
							  	</if>

									GROUP BY  BRNO , ITEM_CD
							) TOTA ,
							(SELECT
									BRNO
									, ITEM_CD
									, SUM( NVL( UO_SPMT_AMT , 0 ) ) AS UO_SPMT_AMT
									, SUM( NVL( UO_OTHER_SPMT_AMT , 0 ) ) AS UO_OTHER_SPMT_AMT
								FROM TB_EV_UO_ISO_PRCHS_PRCHS_SLS_TOT
								WHERE 1=1
								AND APO_SE = '2'
								AND TYPE_SE_NO IN ('7')

								<if test='uoBrno != null and uoBrno != ""'>
							  	  AND UO_BRNO = #{uoBrno}
							  	</if>
							  	<if test='brno != null and brno != ""'>
							  	  AND BRNO = #{brno}
							  	</if>
							  	<if test='yr != null and yr != ""'>
							  	  AND YR = #{yr}
							  	</if>

								GROUP BY  BRNO , ITEM_CD
							) TOTB
						WHERE 1=1
						AND ITEM.ITEM_CD = TOTA.ITEM_CD(+)
						AND ITEM.ITEM_CD = TOTB.ITEM_CD(+)
				)TOT
		)TOTAL
    </select>


	<select id="selectInvShipOgnGenalTblMngIsoList" parameterType="com.at.apcss.pd.isom.vo.InvShipOgnGenalTblMngVO" resultType="com.at.apcss.pd.isom.vo.InvShipOgnGenalTblMngVO">
		<!-- Start 페이징 -->
    	<if test='pagingYn != null and pagingYn.equals("Y")'>
    		SELECT
    			  ROWNUM AS ROW_SEQ
    			, COUNT(*) OVER() AS TOTAL_RECORD_COUNT
    			, pt0.*
    		  FROM (
    	</if>

		SELECT /* com.at.apcss.pd.isom.mapper.InvShipOgnGenalTblMngMapper.selectInvShipOgnGenalTblMngUoList */
			TEA.APO_CD
			,TEA.APO_SE
			,TEA.BRNO
			,TEA.CRNO
			,TEA.CTPV
			,TEA.SGG
			,TEA.CORP_NM
			,TEA.CORP_SE_CD
			,TEAM.YR
		FROM TB_EV_APO TEA
			,TB_EV_APLY_MNG TEAM
		WHERE 1=1
		  AND TEA.BRNO = TEAM.BRNO(+)
		  AND TEA.APO_SE = '2'
		  <if test='brno != null and brno != ""'>
		  AND TEA.BRNO = #{brno}
		  </if>
		  <if test='yr != null and yr != ""'>
		  AND TEAM.YR = #{yr}
		  </if>
		  <if test='cmptnInst != null and cmptnInst != ""'>
		  AND TEA.CMPTN_INST = #{cmptnInst}
		  </if>
		  <if test='ctpv != null and ctpv != ""'>
		  AND TEA.CTPV = #{ctpv}
		  </if>

		  <if test='corpSeCd != null and corpSeCd != ""'>
		  AND TEA.CORP_SE_CD = #{corpSeCd}
		  </if>
		  <if test='corpDtlSeCd != null and corpDtlSeCd != ""'>
		  AND TEA.CORP_DTL_SE_CD = #{corpDtlSeCd}
		  </if>
		  <if test='corpNm != null and corpNm != ""'>
		  AND CM.CORP_NM LIKE '%' || #{corpNm} || '%'
		  </if>

		 <!-- 페이징 -->
		<if test='pagingYn != null and pagingYn.equals("Y")'>
    		  ) pt0
			OFFSET (#{currentPageNo} - 1) * #{recordCountPerPage} ROWS
			FETCH FIRST #{recordCountPerPage} ROWS ONLY
    	</if>
    </select>

</mapper>