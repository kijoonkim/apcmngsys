<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- ==========================================================================	-->
<!-- NAME : BbsMapper.xml                                    				-->
<!-- DESC : 게시판 정보 mapper                                             			-->
<!-- ==========================================================================	-->
<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
<!-- ===========  	============  	===========================================	-->
<!-- 2023.06.29  	jcshin        	Initial Creation                            -->
<!-- ==========================================================================	-->

<mapper namespace="com.at.apcss.pd.pcorm.mapper.PrdcrCrclOgnVluFndsMngMapper">

	<!-- 통합조직 등록결과 리스트 -->
	<select id="selectScoreList" parameterType="com.at.apcss.pd.pcorm.vo.PrdcrCrclOgnVluFndsMngVO" resultType="com.at.apcss.pd.pcorm.vo.PrdcrCrclOgnVluFndsMngVO">
		SELECT /* com.at.apcss.pd.pcorm.mapper.PrdcrCrclOgnVluFndsMngMapper.selectScoreList */
			EAM.YR
			,EAM.BRNO
			,'전문품목  총취급액' AS DD
			,'1' AS AA
			,ETS.BB
			,ETS.CC
			,EAM.SCORE
		FROM (SELECT
					YR
					,BRNO
					,(GREATEST(LEAST(
							ROUND(NVL(
									SUM( (NVL(SLS_TOT_AMT , 0) + NVL(ONLN_WHLSL_MRKT_AMT , 0) )
												*  NVL(SLS_TOT_AMT , 0)
												/ NULLIF(PERC_CONT,0)
												/  NULLIF(SLS_TOT_AMT_TOT,0)
											)
								,0),2)*50
						, 50) ,0)
					)AS SCORE
				FROM
				(SELECT
					ITEM.BRNO
					,ITEM.YR
					,ITEM.CTGRY_CD
					,(CASE WHEN ITEM.CTGRY_CD = '1' THEN TOTA.SLS_TOT_AMT
								WHEN ITEM.CTGRY_CD = '2' THEN TOTB.SLS_TOT_AMT
								WHEN ITEM.CTGRY_CD = '3' THEN TOTC.SLS_TOT_AMT
								ELSE ''
								END
					)AS SLS_TOT_AMT
					,(CASE WHEN ITEM.CTGRY_CD = '1' THEN TOTA.PERC_CONT
								WHEN ITEM.CTGRY_CD = '2' THEN TOTB.PERC_CONT
								WHEN ITEM.CTGRY_CD = '3' THEN TOTC.PERC_CONT
								ELSE ''
								END
					)AS PERC_CONT
					,TOT.SLS_TOT_AMT_TOT
					,NVL((SELECT ROUND(SUM(NVL(ONLN_WHLSL_MRKT_AMT,0)) * 0.2 , 2 )
								FROM TB_EV_UO_ISO_ALL_PRCHS_SLS
								WHERE YR = ITEM.YR
									AND BRNO = ITEM.BRNO
									AND CTGRY_CD = ITEM.CTGRY_CD
									AND PRCHS_SLS_SE = '2') , 0
					) AS ONLN_WHLSL_MRKT_AMT
				FROM
					(SELECT
							EAM.YR
							,EAM.BRNO
							,YGC.CTGRY_CD
						FROM
							(SELECT * FROM TB_EV_APLY_MNG WHERE YR = #{yr} AND APO_SE = '1') EAM
							,(SELECT BRNO , CTGRY_CD FROM TB_EV_APO_YR_GPC_CD WHERE YR = #{yr} AND STTG_UPBR_ITEM_SE = '1' GROUP BY BRNO , CTGRY_CD) YGC
						WHERE 1=1
							AND EAM.BRNO = YGC.BRNO
					) ITEM
					,(SELECT BRNO , SUM( NVL( SLS_CNSGN_PRCHS_AMT , 0 ) ) AS SLS_TOT_AMT_TOT
								FROM TB_EV_UO_ISO_PRCHS_PRCHS_SLS_TOT PSTA
								WHERE 1=1
								  AND APO_SE = '1'
								  AND TYPE_SE_NO IN ('1','3','5','7')
								  AND ITEM_CD = (SELECT ITEM_CD FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTA.YR AND BRNO = PSTA.BRNO AND ITEM_CD = PSTA.ITEM_CD)
								  AND '1' =  (SELECT STTG_UPBR_ITEM_SE FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTA.YR AND BRNO = PSTA.BRNO AND ITEM_CD = PSTA.ITEM_CD)
								  AND YR = #{yr}
								  GROUP BY  BRNO
					) TOT
					,(SELECT BRNO ,CTGRY_CD ,SLS_TOT_AMT ,PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY SLS_TOT_AMT_TOT) OVER () AS PERC_CONT
						FROM
							(SELECT BRNO , '1' AS CTGRY_CD
									,SUM(CASE WHEN TYPE_SE_NO IN ('1', '5') THEN NVL(PSTA.SLS_CNSGN_PRCHS_AMT,0) END) AS SLS_TOT_AMT
									,SUM(CASE WHEN TYPE_SE_NO IN ('1', '3', '5', '7') THEN NVL(PSTA.SLS_CNSGN_PRCHS_AMT,0) END) AS SLS_TOT_AMT_TOT
								FROM TB_EV_UO_ISO_PRCHS_PRCHS_SLS_TOT PSTA
								WHERE 1=1
								  AND APO_SE = '1'
								  AND TYPE_SE_NO IN ('1','3','5','7')
								  AND ITEM_CD = (SELECT ITEM_CD FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTA.YR AND BRNO = PSTA.BRNO AND ITEM_CD = PSTA.ITEM_CD)
								  AND '1' =  (SELECT CTGRY_CD FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTA.YR AND BRNO = PSTA.BRNO AND ITEM_CD = PSTA.ITEM_CD)
								  AND '1' =  (SELECT STTG_UPBR_ITEM_SE FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTA.YR AND BRNO = PSTA.BRNO AND ITEM_CD = PSTA.ITEM_CD)
								  AND YR = #{yr}
								  GROUP BY  BRNO)
					) TOTA
					,(SELECT BRNO ,CTGRY_CD ,SLS_TOT_AMT ,PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY SLS_TOT_AMT_TOT) OVER () AS PERC_CONT
						FROM
							(SELECT BRNO , '2' AS CTGRY_CD
									,SUM(CASE WHEN TYPE_SE_NO IN ('1', '5') THEN NVL(PSTB.SLS_CNSGN_PRCHS_AMT,0) END) AS SLS_TOT_AMT
									,SUM(CASE WHEN TYPE_SE_NO IN ('1', '3', '5', '7') THEN NVL(PSTB.SLS_CNSGN_PRCHS_AMT,0) END) AS SLS_TOT_AMT_TOT
								FROM TB_EV_UO_ISO_PRCHS_PRCHS_SLS_TOT PSTB
								WHERE 1=1
								  AND APO_SE = '1'
								  AND TYPE_SE_NO IN ('1','3','5','7')
								  AND ITEM_CD = (SELECT ITEM_CD FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTB.YR AND BRNO = PSTB.BRNO AND ITEM_CD = PSTB.ITEM_CD)
								  AND '2' =  (SELECT CTGRY_CD FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTB.YR AND BRNO = PSTB.BRNO AND ITEM_CD = PSTB.ITEM_CD)
								  AND '1' =  (SELECT STTG_UPBR_ITEM_SE FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTB.YR AND BRNO = PSTB.BRNO AND ITEM_CD = PSTB.ITEM_CD)
								  AND YR = #{yr}
								  GROUP BY  BRNO)
					)TOTB
					,(SELECT BRNO ,CTGRY_CD ,SLS_TOT_AMT ,PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY SLS_TOT_AMT_TOT) OVER () AS PERC_CONT
						FROM
							(SELECT BRNO , '3' AS CTGRY_CD
									,SUM(CASE WHEN TYPE_SE_NO IN ('1', '5') THEN NVL(PSTC.SLS_CNSGN_PRCHS_AMT,0) END) AS SLS_TOT_AMT
									,SUM(CASE WHEN TYPE_SE_NO IN ('1', '3', '5', '7') THEN NVL(PSTC.SLS_CNSGN_PRCHS_AMT,0) END) AS SLS_TOT_AMT_TOT
								FROM TB_EV_UO_ISO_PRCHS_PRCHS_SLS_TOT PSTC
								WHERE 1=1
								  AND APO_SE = '1'
								  AND TYPE_SE_NO IN ('1','3','5','7')
								  AND ITEM_CD = (SELECT ITEM_CD FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTC.YR AND BRNO = PSTC.BRNO AND ITEM_CD = PSTC.ITEM_CD)
								  AND '3' =  (SELECT CTGRY_CD FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTC.YR AND BRNO = PSTC.BRNO AND ITEM_CD = PSTC.ITEM_CD)
								  AND '1' =  (SELECT STTG_UPBR_ITEM_SE FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTC.YR AND BRNO = PSTC.BRNO AND ITEM_CD = PSTC.ITEM_CD)
								  AND YR = #{yr}
								  GROUP BY  BRNO)
					)TOTC
					WHERE 1=1
						AND ITEM.BRNO = TOT.BRNO(+)
						AND ITEM.BRNO = TOTA.BRNO(+)
						AND ITEM.CTGRY_CD = TOTA.CTGRY_CD(+)
						AND ITEM.BRNO = TOTB.BRNO(+)
						AND ITEM.CTGRY_CD = TOTB.CTGRY_CD(+)
						AND ITEM.BRNO = TOTC.BRNO(+)
						AND ITEM.CTGRY_CD = TOTC.CTGRY_CD(+)
						AND SLS_TOT_AMT_TOT IS NOT NULL
						AND SLS_TOT_AMT_TOT > 0
					)
					WHERE 1=1
					  AND BRNO = #{brno}
					GROUP BY YR , BRNO
					ORDER BY SCORE DESC
			) EAM
			, (SELECT * FROM TB_EV_TEST_SCORE WHERE BRNO = #{brno} AND YR = #{yr} AND AA = '1') ETS
		WHERE 1=1
			AND EAM.BRNO = ETS.BRNO(+)

		UNION ALL

		SELECT
			EAM.YR
			,EAM.BRNO
			,'전문품목  전속취급율' AS DD
			,'2' AS AA
			,ETS.BB
			,ETS.CC
			,EAM.SCORE
		FROM (SELECT
					YR
					,BRNO
					,(GREATEST(LEAST(
							ROUND(NVL(
											SUM(
												NVL(SLS_TOT_AMT_RT,0)
												*  ( NVL(SLS_TOT_AMT,0) + NVL(ONLN_WHLSL_MRKT_AMT,0) )
												/ NULLIF(PERC_CONT,0)
												/ NULLIF(SLS_TOT_AMT_TOT,0)
												* 50
												)
									,0),2)
						, 50) ,0)
					)AS SCORE
				FROM
				(SELECT
					ITEM.BRNO
					,ITEM.YR
					,ITEM.CTGRY_CD
					,(CASE WHEN ITEM.CTGRY_CD = '1' THEN TOTA.SLS_TOT_AMT
								WHEN ITEM.CTGRY_CD = '2' THEN TOTB.SLS_TOT_AMT
								WHEN ITEM.CTGRY_CD = '3' THEN TOTC.SLS_TOT_AMT
								ELSE ''
								END
					)AS SLS_TOT_AMT
					,(CASE WHEN ITEM.CTGRY_CD = '1' THEN TOTA.SLS_TOT_AMT_RT
								WHEN ITEM.CTGRY_CD = '2' THEN TOTB.SLS_TOT_AMT_RT
								WHEN ITEM.CTGRY_CD = '3' THEN TOTC.SLS_TOT_AMT_RT
								ELSE ''
								END
					)AS SLS_TOT_AMT_RT
					,(CASE WHEN ITEM.CTGRY_CD = '1' THEN TOTA.PERC_CONT
								WHEN ITEM.CTGRY_CD = '2' THEN TOTB.PERC_CONT
								WHEN ITEM.CTGRY_CD = '3' THEN TOTC.PERC_CONT
								ELSE ''
								END
					)AS PERC_CONT
					,TOT.SLS_TOT_AMT_TOT
					,NVL((SELECT ROUND(NVL(SUM(NVL(ONLN_WHLSL_MRKT_AMT,0)),0) * 0.2 , 2 )
								FROM TB_EV_UO_ISO_ALL_PRCHS_SLS
								WHERE YR = ITEM.YR
									AND BRNO = ITEM.BRNO
									AND CTGRY_CD = ITEM.CTGRY_CD
									AND PRCHS_SLS_SE = '2') , 0
					) AS ONLN_WHLSL_MRKT_AMT
				FROM
					(SELECT
							EAM.YR
							,EAM.BRNO
							,YGC.CTGRY_CD
						FROM
							(SELECT * FROM TB_EV_APLY_MNG WHERE YR = #{yr} AND APO_SE = '1') EAM
							,(SELECT BRNO , CTGRY_CD FROM TB_EV_APO_YR_GPC_CD WHERE YR = #{yr} AND STTG_UPBR_ITEM_SE = '1' GROUP BY BRNO , CTGRY_CD) YGC
						WHERE 1=1
							AND EAM.BRNO = YGC.BRNO
					) ITEM
					,(SELECT BRNO , SUM( NVL( SLS_CNSGN_PRCHS_AMT , 0 ) ) AS SLS_TOT_AMT_TOT
								FROM TB_EV_UO_ISO_PRCHS_PRCHS_SLS_TOT PSTA
								WHERE 1=1
								  AND APO_SE = '1'
								  AND TYPE_SE_NO IN ('1','3','5','7')
								  AND ITEM_CD = (SELECT ITEM_CD FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTA.YR AND BRNO = PSTA.BRNO AND ITEM_CD = PSTA.ITEM_CD)
								  AND '1' =  (SELECT STTG_UPBR_ITEM_SE FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTA.YR AND BRNO = PSTA.BRNO AND ITEM_CD = PSTA.ITEM_CD)
								  AND YR = #{yr}
								  GROUP BY  BRNO
					) TOT
					,(SELECT BRNO ,CTGRY_CD , SLS_TOT_AMT ,SLS_TOT_AMT_RT ,PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY SLS_TOT_AMT_RT) OVER () AS PERC_CONT
					FROM
						(SELECT BRNO , '1' AS CTGRY_CD
								,NVL( ROUND( NVL(SUM(CASE WHEN TYPE_SE_NO IN ('1', '3', '5', '7') THEN NVL(PSTA.SLS_CNSGN_PRCHS_AMT,0) END) ,0)
																/ NULLIF(SUM(CASE WHEN TYPE_SE_NO IN ('1', '5') THEN NVL(PSTA.SLS_CNSGN_PRCHS_AMT,0) END), 0)
													,2) ,0
								) AS SLS_TOT_AMT_RT
								,SUM(CASE WHEN TYPE_SE_NO IN ('1', '5') THEN NVL(PSTA.SLS_CNSGN_PRCHS_AMT,0) END) AS SLS_TOT_AMT
								FROM TB_EV_UO_ISO_PRCHS_PRCHS_SLS_TOT PSTA
								WHERE 1=1
								  AND APO_SE = '1'
								  AND TYPE_SE_NO IN ('1', '3', '5', '7')
								  AND ITEM_CD = (SELECT ITEM_CD FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTA.YR AND BRNO = PSTA.BRNO AND ITEM_CD = PSTA.ITEM_CD)
								  AND '1' =  (SELECT CTGRY_CD FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTA.YR AND BRNO = PSTA.BRNO AND ITEM_CD = PSTA.ITEM_CD)
								  AND '1' =  (SELECT STTG_UPBR_ITEM_SE FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTA.YR AND BRNO = PSTA.BRNO AND ITEM_CD = PSTA.ITEM_CD)
								  AND YR = #{yr}
								  GROUP BY  BRNO)
					) TOTA
					,(SELECT BRNO ,CTGRY_CD , SLS_TOT_AMT ,SLS_TOT_AMT_RT ,PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY SLS_TOT_AMT_RT) OVER () AS PERC_CONT
					FROM
						(SELECT BRNO , '2' AS CTGRY_CD
								,NVL( ROUND( NVL(SUM(CASE WHEN TYPE_SE_NO IN ('1', '3', '5', '7') THEN NVL(PSTA.SLS_CNSGN_PRCHS_AMT,0) END) ,0)
																/ NULLIF(SUM(CASE WHEN TYPE_SE_NO IN ('1', '5') THEN NVL(PSTA.SLS_CNSGN_PRCHS_AMT,0) END), 0)
													,2) ,0
								) AS SLS_TOT_AMT_RT
								,SUM(CASE WHEN TYPE_SE_NO IN ('1', '3', '5', '7') THEN NVL(PSTA.SLS_CNSGN_PRCHS_AMT,0) END) AS A
								,SUM(CASE WHEN TYPE_SE_NO IN ('1', '5') THEN NVL(PSTA.SLS_CNSGN_PRCHS_AMT,0) END) AS SLS_TOT_AMT
								FROM TB_EV_UO_ISO_PRCHS_PRCHS_SLS_TOT PSTA
								WHERE 1=1
								  AND APO_SE = '1'
								  AND TYPE_SE_NO IN ('1', '3', '5', '7')
								  AND ITEM_CD = (SELECT ITEM_CD FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTA.YR AND BRNO = PSTA.BRNO AND ITEM_CD = PSTA.ITEM_CD)
								  AND '2' =  (SELECT CTGRY_CD FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTA.YR AND BRNO = PSTA.BRNO AND ITEM_CD = PSTA.ITEM_CD)
								  AND '1' =  (SELECT STTG_UPBR_ITEM_SE FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTA.YR AND BRNO = PSTA.BRNO AND ITEM_CD = PSTA.ITEM_CD)
								  AND YR = #{yr}
								  GROUP BY  BRNO)
					)TOTB
					,(SELECT BRNO ,CTGRY_CD , SLS_TOT_AMT ,SLS_TOT_AMT_RT ,PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY SLS_TOT_AMT_RT) OVER () AS PERC_CONT
					FROM
						(SELECT BRNO , '3' AS CTGRY_CD
								,NVL( ROUND( NVL(SUM(CASE WHEN TYPE_SE_NO IN ('1', '3', '5', '7') THEN NVL(PSTA.SLS_CNSGN_PRCHS_AMT,0) END) ,0)
																/ NULLIF(SUM(CASE WHEN TYPE_SE_NO IN ('1', '5') THEN NVL(PSTA.SLS_CNSGN_PRCHS_AMT,0) END), 0)
													,2) ,0
								) AS SLS_TOT_AMT_RT
								,SUM(CASE WHEN TYPE_SE_NO IN ('1', '3', '5', '7') THEN NVL(PSTA.SLS_CNSGN_PRCHS_AMT,0) END) AS A
								,SUM(CASE WHEN TYPE_SE_NO IN ('1', '5') THEN NVL(PSTA.SLS_CNSGN_PRCHS_AMT,0) END) AS SLS_TOT_AMT
								FROM TB_EV_UO_ISO_PRCHS_PRCHS_SLS_TOT PSTA
								WHERE 1=1
								  AND APO_SE = '1'
								  AND TYPE_SE_NO IN ('1', '3', '5', '7')
								  AND ITEM_CD = (SELECT ITEM_CD FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTA.YR AND BRNO = PSTA.BRNO AND ITEM_CD = PSTA.ITEM_CD)
								  AND '3' =  (SELECT CTGRY_CD FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTA.YR AND BRNO = PSTA.BRNO AND ITEM_CD = PSTA.ITEM_CD)
								  AND '1' =  (SELECT STTG_UPBR_ITEM_SE FROM TB_EV_APO_YR_GPC_CD WHERE YR = PSTA.YR AND BRNO = PSTA.BRNO AND ITEM_CD = PSTA.ITEM_CD)
								  AND YR = #{yr}
								  GROUP BY  BRNO)
					)TOTC
					WHERE 1=1
						AND ITEM.BRNO = TOT.BRNO(+)
						AND ITEM.BRNO = TOTA.BRNO(+)
						AND ITEM.CTGRY_CD = TOTA.CTGRY_CD(+)
						AND ITEM.BRNO = TOTB.BRNO(+)
						AND ITEM.CTGRY_CD = TOTB.CTGRY_CD(+)
						AND ITEM.BRNO = TOTC.BRNO(+)
						AND ITEM.CTGRY_CD = TOTC.CTGRY_CD(+)
						AND SLS_TOT_AMT_TOT IS NOT NULL
						AND SLS_TOT_AMT_TOT > 0
					)
					WHERE 1=1
					  AND BRNO = #{brno}
					GROUP BY YR , BRNO
					ORDER BY SCORE DESC
			) EAM
			, (SELECT * FROM TB_EV_TEST_SCORE WHERE BRNO = #{brno} AND YR = #{yr} AND AA = '2') ETS
		WHERE 1=1
			AND EAM.BRNO = ETS.BRNO(+)

		UNION ALL

		SELECT
			ETS.YR
			,ETS.BRNO
			,'' AS DD
			,ETS.AA
			,ETS.BB
			,ETS.CC
			,ETS.SCORE
		FROM
			TB_EV_TEST_SCORE ETS
		WHERE 1=1
			AND AA = '3'
			AND BRNO = #{brno}
			AND YR = #{yr}
	</select>
</mapper>