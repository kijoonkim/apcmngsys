<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >


<mapper namespace="com.at.apcss.pd.sprt.mapper.SprtBizRsltInqMapper">

    <select id="selectSprtBizRsltInqList" parameterType="com.at.apcss.pd.sprt.vo.SprtBizRsltInqVO" resultType="com.at.apcss.pd.sprt.vo.SprtBizRsltInqVO">

        SELECT
        ROWNUM AS ROW_SEQ
        , COUNT(*) OVER() AS TOTAL_RECORD_COUNT
        , pt0.*
        FROM (

        SELECT T1.SPRT_BIZ_YR AS SPRT_BIZ_YR
             , T1.SPRT_BIZ_NM AS SPRT_BIZ_NM
             , T1.BZMN_CONM AS BZMN_CONM
             , T1. CRNO AS CRNO
             , T1.BRNO AS BRNO
             , ( SELECT FN_GET_COM_CD_VL_NM('UNTY_CTPV', T1.STDG_CTPV_CD) FROM DUAL ) AS STDG_CTPV_CD
             , ( SELECT FN_GET_COM_CD_VL_EXPLN('UNTY_SGG', T1.STDG_CD) FROM DUAL ) AS STDG_SGG_CD
             , T1.SLCTN_YR AS SLCTN_YR
             , T1.SPRT_YR AS SPRT_YR
             , T1.ALTMNT_AMT AS ALTMNT_AMT
             , T1.ONSLF_BRDN_AMT AS ONSLF_BRDN_AMT
             , T1.ALTMNT_INT AS ALTMNT_INT
             , T1.RMRK AS RMRK

             , ( SELECT ITEM_NM FROM TB_ITEM_CRTR WHERE ITEM_CD = T1.ITEM_CD ) AS ITEM_CD
             , ( SELECT FN_GET_COM_CD_VL_NM ('WRHS_SE_CD', T1.WRHS_SE_CD ) FROM DUAL) AS BIZ_TYPE

          FROM (  SELECT A.SPRT_BIZ_YR AS SPRT_BIZ_YR
                       , A.SPRT_BIZ_NM AS SPRT_BIZ_NM
                       , C.BZMN_CONM AS BZMN_CONM
                       , CASE
                             WHEN C.PSN_SE_CD = '2' THEN B.CRNO
                             ELSE ''
                          END AS CRNO
                       , CASE
                             WHEN C.PSN_SE_CD = '2' THEN B.BRNO
                             ELSE ''
                          END AS BRNO
                       , C.STDG_CTPV_CD AS STDG_CTPV_CD
                       , C.STDG_CD AS STDG_CD
                       , D.SLCTN_YR AS SLCTN_YR
                       , D.SPRT_YR AS SPRT_YR
                       , D.ALTMNT_AMT AS ALTMNT_AMT
                       , D.ALTMNT_INT AS ALTMNT_INT
                       , D.RMRK AS RMRK
                       , D.ONSLF_BRDN_AMT AS ONSLF_BRDN_AMT
                       , D.SPRT_BIZ_CD AS SPRT_BIZ_CD
                       , D.SPRT_OGNZ_ID AS SPRT_OGNZ_ID
                       , D.REG_SEQ AS REG_SEQ
                       , E.ITEM_CD AS ITEM_CD
                       , E.WRHS_SE_CD AS WRHS_SE_CD
                  FROM TB_EV_SPRT_BIZ_MSTR A
                     , TB_EV_SPRT_BIZ_OGNZ B
                     , TB_COM_CORP_BZMN C
                     , TB_EV_SPRT_BIZ_ALTMNT D
                     , ( SELECT SPRT_BIZ_YR
                              , SPRT_BIZ_CD
                              , SPRT_OGNZ_ID
                              , REG_SEQ
                              , MAX( CASE
                                        WHEN ATRB_CD = 'ITEM_CD' THEN ATRB_NM
                                      END ) AS ITEM_CD
                              , MAX( CASE
                                        WHEN ATRB_CD = 'WRHS_SE_CD' THEN ATRB_NM
                                      END ) AS WRHS_SE_CD
                           FROM TB_EV_SPRT_BIZ_ALTMNT_ATRB
                          WHERE 1=1
                            AND DEL_YN = 'N'
                       GROUP BY SPRT_BIZ_YR
                              , SPRT_BIZ_CD
                              , SPRT_OGNZ_ID
                              , REG_SEQ ) E
                  WHERE 1=1
                    AND A.SPRT_BIZ_YR = B.SPRT_BIZ_YR
                    AND A.SPRT_BIZ_CD = B.SPRT_BIZ_CD
                    AND B.BRNO = C.BRNO
                    AND B.SPRT_BIZ_YR = D.SPRT_BIZ_YR
                    AND B.SPRT_BIZ_CD = D.SPRT_BIZ_CD
                    AND B.SPRT_OGNZ_ID = D.SPRT_OGNZ_ID
                    AND D.SPRT_BIZ_YR = E.SPRT_BIZ_YR(+)
                    AND D.SPRT_BIZ_CD = E.SPRT_BIZ_CD(+)
                    AND D.SPRT_OGNZ_ID = E.SPRT_OGNZ_ID(+)
                    AND D.REG_SEQ = E.REG_SEQ(+)
                    AND C.USE_YN = 'Y'
                    AND A.DEL_YN = 'N'
                    AND B.DEL_YN = 'N'
                    AND C.DEL_YN = 'N'
                    AND D.DEL_YN = 'N'
                <if test='sprtBizSe != null and sprtBizSe != ""'>
                    AND A.SPRT_BIZ_CD = #{sprtBizSe}
                </if>
                <if test='crtrYmdFrom != null and crtrYmdFrom != "" and crtrYmdTo != null and crtrYmdTo != ""'>
                    AND A.SPRT_BIZ_YR BETWEEN #{crtrYmdFrom} AND #{crtrYmdTo}
                </if>
                    AND B.CRNO LIKE '%' || #{crno} || '%'
                    AND B.BRNO LIKE '%' || #{brno} || '%'
                    AND C.BZMN_CONM LIKE '%' || #{bzmnConm} || '%'
                <if test='sprtYmdFrom != null and sprtYmdFrom != "" and sprtYmdTo != null and sprtYmdTo != ""'>
                    AND D.SPRT_YR BETWEEN #{sprtYmdFrom} AND #{sprtYmdTo}
                </if>
                  ORDER BY SPRT_BIZ_YR DESC, SPRT_BIZ_NM
            ) T1

          ) pt0


    </select>

    <select id="selectSprtBizRsltInqSeCd" parameterType="com.at.apcss.pd.sprt.vo.SprtBizRsltInqVO" resultType="com.at.apcss.pd.sprt.vo.SprtBizRsltInqVO">
        SELECT ROWNUM AS ROW_SEQ
             , pt0.*
        FROM (
                 SELECT MIN(SPRT_BIZ_YR) AS SPRT_BIZ_YR_MIN
                      , MAX(SPRT_BIZ_YR) AS SPRT_BIZ_YR_MAX
                      , SPRT_BIZ_CD
                      , SPRT_BIZ_NM
                 FROM TB_EV_SPRT_BIZ_MSTR
                 WHERE 1=1
                   AND DEL_YN = 'N'
                 GROUP BY SPRT_BIZ_NM, SPRT_BIZ_CD
                 ORDER BY SPRT_BIZ_NM
             ) pt0
    </select>

    <select id="selectComCorpBzmn" parameterType="com.at.apcss.pd.sprt.vo.SprtBizRsltInqVO" resultType="com.at.apcss.pd.sprt.vo.SprtBizRsltInqVO">
        SELECT ROWNUM AS ROW_SEQ
             , pt0.*
        FROM (
                 SELECT BRNO AS BRNO
                      , BZMN_CONM AS BZMN_CONM
                 FROM TB_COM_CORP_BZMN
             ) pt0
    </select>

    <select id="selectComCorp" parameterType="com.at.apcss.pd.sprt.vo.SprtBizRsltInqVO" resultType="com.at.apcss.pd.sprt.vo.SprtBizRsltInqVO">
        SELECT ROWNUM AS ROW_SEQ
             , pt0.*
        FROM (
                 SELECT CRNO AS CRNO
                      , CORP_NM AS CORP_NM
                 FROM TB_COM_CORP
             ) pt0
    </select>

    <insert id="insertSprtBizRsltInqList" parameterType="com.at.apcss.pd.sprt.vo.SprtBizRsltInqVO">
    </insert>

    <insert id="insertSpComCorpAdd" statementType="CALLABLE" parameterType="com.at.apcss.pd.sprt.vo.SprtBizRsltInqVO">
    	<![CDATA[
        {   call SP_COM_CORP_ADD (
            'test'
            ,'test'
/*                  #{userId}
                , #{prgrmId}*/
                , #{crno}
                , #{corpNm}
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , #{errCd, jdbcType=VARCHAR, mode=OUT}
                , #{errMsg, jdbcType=VARCHAR, mode=OUT}
            )
        }
        ]]>
    </insert>

    <insert id="insertSpComBzmnAdd" statementType="CALLABLE" parameterType="com.at.apcss.pd.sprt.vo.SprtBizRsltInqVO">
    	<![CDATA[
        {   call SP_COM_BZMN_ADD (
                  #{userId}
                , #{prgrmId}
                , #{brno}
                , #{psnSeCd}
                , #{bzmnConm}
                , #{crno}
                , #{ognzCd}
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , ''
                , #{stdgCtpvCd}
                , #{stdgSggCd}
                , #{stdgCd}
                , #{instNo, jdbcType=VARCHAR, mode=OUT}
                , #{ognzCd, jdbcType=VARCHAR, mode=OUT}
                , #{errCd, jdbcType=VARCHAR, mode=OUT}
                , #{errMsg, jdbcType=VARCHAR, mode=OUT}
            )
        }
        ]]>
    </insert>

</mapper>
