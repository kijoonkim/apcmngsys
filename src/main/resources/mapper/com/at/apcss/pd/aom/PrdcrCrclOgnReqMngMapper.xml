<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- ==========================================================================	-->
<!-- NAME : BbsMapper.xml                                    				-->
<!-- DESC : 게시판 정보 mapper                                             			-->
<!-- ==========================================================================	-->
<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
<!-- ===========  	============  	===========================================	-->
<!-- 2023.06.29  	jcshin        	Initial Creation                            -->
<!-- ==========================================================================	-->

<mapper namespace="com.at.apcss.pd.aom.mapper.PrdcrCrclOgnReqMngMapper">

	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.fm.bbs.mapper.BbsMngMapper.selectBbs				-->
	<!-- DESC : 게시판 테이블 단건조회.                                             		-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.06.29  	jcshin        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <select id="selectPrdcrCrclOgnReqMng" parameterType="com.at.apcss.pd.aom.vo.PrdcrCrclOgnReqMngVO" resultType="com.at.apcss.pd.aom.vo.PrdcrCrclOgnReqMngVO">
    	<![CDATA[
			SELECT /* com.at.apcss.pd.aom.mapper.PrdcrCrclOgnReqMngMapper.selectPrdcrCrclOgnReqMng */
				  CM.APO_CD
				, CM.APO_SE
				, CM.CTPV
				, CM.SGG
				, CM.CORP_NM
				, CM.BRNO
				, CM.CRNO

				, CM.PIC_FLNM
				, CM.ZIP
				, CM.LOTNO_ADDR
				, CM.LOTNO_DTL_ADDR
				, CM.ROAD_NM_ADDR
				, CM.ROAD_NM_DTL_ADDR
				, CM.CORP_SE_CD
				, CM.CORP_DTL_SE_CD
				, CM.CORP_FNDN_DAY
				, CM.INVST_NOPE
				, CM.INVST_EXPND_FRMER_NOPE
				, CM.INVST_AMT
				, CM.FRMER_INVST_AMT
				, CM.PRDCR_GRP_INVST_AMT
				, CM.LOCGOV_INVST_AMT
				, CM.ETC_INVST_AMT
				, CM.RGLLBR_NOPE
				, CM.DW_NOPE
				, CM.DLBRR_NOPE
				, CM.ISO_HLD_YN
				, CM.UNTY_YN
				, CM.UO_BRNO
				, CM.UO_NM
				, CM.UNTY_YR
				, CM.APRV

				, EAM.YR
				, EAM.APLY_DAY

				,(CASE WHEN TRIM(RAW_MTR_ENSR_SIGUN_CNT) IS NOT NULL THEN '1'
						WHEN TRIM(RAW_MTR_ENSR_CTPV_CNT) IS NOT NULL THEN '2'
						END
				) AS RAW_MTR_ENSR
				, EAM.RAW_MTR_ENSR_SIGUN_CNT
				, EAM.RAW_MTR_ENSR_CTPV_CNT
				, EAM.CTPV_NM
				, EAM.SIGUN_NM
				, EAM.PRUO_FUND_APLY_AMT
				, EAM.ISO_FUND_APLY_AMT
				, EAM.APLY_TRGT_SE

				, CM.SYS_FRST_INPT_DT		AS SYS_FRST_INPT_DT
				, TO_CHAR(CM.SYS_FRST_INPT_DT,'YYYY-MM-DD')		AS SYS_FRST_INPT_DT_YMD
				, CM.SYS_FRST_INPT_USER_ID	AS SYS_FRST_INPT_USER_ID
				, (SELECT USER_NM FROM TB_COM_USER WHERE USER_ID = CM.SYS_FRST_INPT_USER_ID) AS SYS_FRST_INPT_USER_NM
				, CM.SYS_FRST_INPT_PRGRM_ID	AS SYS_FRST_INPT_PRGRM_ID

				, CM.SYS_LAST_CHG_DT		AS SYS_LAST_CHG_DT
				, TO_CHAR(CM.SYS_LAST_CHG_DT,'YYYY-MM-DD')		AS SYS_LAST_CHG_DT_YMD
				, CM.SYS_LAST_CHG_USER_ID	AS SYS_LAST_CHG_USER_ID
				, (SELECT USER_NM FROM TB_COM_USER WHERE USER_ID = CM.SYS_LAST_CHG_USER_ID) AS SYS_LAST_CHG_USER_NM
				, CM.SYS_LAST_CHG_PRGRM_ID	AS SYS_LAST_CHG_PRGRM_ID
			  FROM TB_EV_APO CM , TB_EV_APLY_MNG EAM
			 WHERE 1=1
			   AND CM.BRNO = EAM.BRNO(+)
			   AND CM.APO_SE IS NOT NULL
			   AND CM.APO_CD IS NOT NULL
    	]]>
    		<if test='apoSe != null and apoSe != ""'>
				AND CM.APO_SE = #{apoSe}
			</if>
    		<if test='cmptnInst != null and cmptnInst != ""'>
				AND CM.CMPTN_INST = #{cmptnInst}
			</if>
			<if test='ctpv != null and ctpv != ""'>
				AND CM.II_CODE = #{ctpv}
			</if>
			<if test='corpSeCd != null and corpSeCd != ""'>
				AND CM.CORP_SE_CD = #{corpSeCd}
			</if>
			<if test='corpDtlSeCd != null and corpDtlSeCd != ""'>
				AND CM.CORP_DTL_SE_CD = #{corpDtlSeCd}
			</if>
			<if test='brno != null and brno != ""'>
				AND CM.BRNO = #{brno}
			</if>
			<if test='corpNm != null and corpNm != ""'>
				AND CM.CORP_NM LIKE '%' || #{corpNm} || '%'
			</if>
			<if test='yr != null and yr != ""'>
				AND EAM.YR = #{yr}
			</if>

		ORDER BY CM.CORP_NM DESC
    </select>


	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.fm.bbs.mapper.BbsMngMapper.selectBbsList			-->
	<!-- DESC : 게시판 테이블 목록 조회.                                             		-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.06.29  	jcshin        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <select id="selectPrdcrCrclOgnReqMngList" parameterType="com.at.apcss.pd.aom.vo.PrdcrCrclOgnReqMngVO" resultType="com.at.apcss.pd.aom.vo.PrdcrCrclOgnReqMngVO">

    	<!-- Start 페이징 -->
    	<if test='pagingYn != null and pagingYn.equals("Y")'>
    		SELECT
    			  ROWNUM AS ROW_SEQ
    			, COUNT(*) OVER() AS TOTAL_RECORD_COUNT
    			, pt0.*
    		  FROM (
    	</if>

			SELECT /* com.at.apcss.pd.aom.mapper.PrdcrCrclOgnReqMngMapper.selectPrdcrCrclOgnReqMngList */
				  CM.APO_CD
				, CM.APO_SE
				, CM.CTPV
				, CM.SGG
				, CM.CORP_NM
				, CM.BRNO
				, CM.CRNO

				, CM.PIC_FLNM
				, CM.ZIP
				, CM.LOTNO_ADDR
				, CM.LOTNO_DTL_ADDR
				, CM.ROAD_NM_ADDR
				, CM.ROAD_NM_DTL_ADDR
				, CM.CORP_SE_CD
				, CM.CORP_DTL_SE_CD
				, CM.CORP_FNDN_DAY
				, CM.INVST_NOPE
				, CM.INVST_EXPND_FRMER_NOPE
				, CM.INVST_AMT
				, CM.FRMER_INVST_AMT
				, CM.PRDCR_GRP_INVST_AMT
				, CM.LOCGOV_INVST_AMT
				, CM.ETC_INVST_AMT
				, CM.RGLLBR_NOPE
				, CM.DW_NOPE
				, CM.DLBRR_NOPE
				, CM.ISO_HLD_YN
				, CM.UNTY_YN
				, CM.UO_BRNO
				, CM.UO_NM
				, CM.UNTY_YR
				, CM.APRV
				, CM.STBLT_YN

				, EAM.YR
				, EAM.APLY_DAY
				,(CASE WHEN TRIM(RAW_MTR_ENSR_SIGUN_CNT) IS NOT NULL THEN '1'
						WHEN TRIM(RAW_MTR_ENSR_CTPV_CNT) IS NOT NULL THEN '2'
						END
				) AS RAW_MTR_ENSR

				, EAM.RAW_MTR_ENSR_SIGUN_CNT
				, EAM.RAW_MTR_ENSR_CTPV_CNT
				, EAM.CTPV_NM
				, EAM.SIGUN_NM
				, EAM.PRUO_FUND_APLY_AMT
				, (SELECT SUM(ISO_FUND_APLY_AMT) FROM TB_EV_APLY_MNG WHERE UO_BRNO =  CM.BRNO) AS ISO_FUND_APLY_AMT
				, EAM.APLY_TRGT_SE

				, CM.SYS_FRST_INPT_DT		AS SYS_FRST_INPT_DT
				, TO_CHAR(CM.SYS_FRST_INPT_DT,'YYYY-MM-DD')		AS SYS_FRST_INPT_DT_YMD
				, CM.SYS_FRST_INPT_USER_ID	AS SYS_FRST_INPT_USER_ID
				, (SELECT USER_NM FROM TB_COM_USER WHERE USER_ID = CM.SYS_FRST_INPT_USER_ID) AS SYS_FRST_INPT_USER_NM
				, CM.SYS_FRST_INPT_PRGRM_ID	AS SYS_FRST_INPT_PRGRM_ID

				, CM.SYS_LAST_CHG_DT		AS SYS_LAST_CHG_DT
				, TO_CHAR(CM.SYS_LAST_CHG_DT,'YYYY-MM-DD')		AS SYS_LAST_CHG_DT_YMD
				, CM.SYS_LAST_CHG_USER_ID	AS SYS_LAST_CHG_USER_ID
				, (SELECT USER_NM FROM TB_COM_USER WHERE USER_ID = CM.SYS_LAST_CHG_USER_ID) AS SYS_LAST_CHG_USER_NM
				, CM.SYS_LAST_CHG_PRGRM_ID	AS SYS_LAST_CHG_PRGRM_ID
			  FROM (SELECT *
			  		FROM TB_EV_APO
			  		WHERE 1=1
			  		<if test='brno != null and brno != ""'>
			  		  AND BRNO = #{brno}
			  		  <if test='userType == "21"'>
			  		   OR BRNO IN (SELECT ISO_BRNO FROM TB_EV_APO_UO_CD WHERE UO_BRNO = #{brno})
			  		  </if>
			  		</if>
			  		) CM
			  		, (SELECT *
			  			FROM TB_EV_APLY_MNG
			  			WHERE 1=1
			  			<if test='userType == "21" or userType == "22"'>
			  		  	  AND YR = TO_CHAR(SYSDATE,'YYYY')
			  			</if>
			  			) EAM
			 WHERE 1=1
			   AND CM.BRNO = EAM.BRNO(+)
			   AND CM.APO_SE IS NOT NULL
			   AND CM.APO_CD IS NOT NULL

    		<if test='apoSe != null and apoSe != ""'>
				AND CM.APO_SE = #{apoSe}
			</if>
    		<if test='cmptnInst != null and cmptnInst != ""'>
				AND CM.CMPTN_INST = #{cmptnInst}
			</if>
			<if test='ctpv != null and ctpv != ""'>
				AND CM.II_CODE = #{ctpv}
			</if>
			<if test='corpSeCd != null and corpSeCd != ""'>
				AND CM.CORP_SE_CD = #{corpSeCd}
			</if>
			<if test='corpDtlSeCd != null and corpDtlSeCd != ""'>
				AND CM.CORP_DTL_SE_CD = #{corpDtlSeCd}
			</if>
			<if test='corpNm != null and corpNm != ""'>
				AND CM.CORP_NM LIKE '%' || #{corpNm} || '%'
			</if>
			<if test='yr != null and yr != ""'>
				AND EAM.YR = #{yr}
			</if>

		ORDER BY CM.CORP_NM DESC
		<!-- 페이징 -->
		<if test='pagingYn != null and pagingYn.equals("Y")'>
    		  ) pt0
			OFFSET (#{currentPageNo} - 1) * #{recordCountPerPage} ROWS
			FETCH FIRST #{recordCountPerPage} ROWS ONLY
    	</if>
    </select>

	<insert id="insertPrdcrCrclOgnReqMng" parameterType="com.at.apcss.pd.aom.vo.PrdcrCrclOgnReqMngVO">
    	<![CDATA[
	    	INSERT /* com.at.apcss.pd.aom.mapper.PrdcrCrclOgnReqMngMapper.insertPrdcrCrclOgnReqMng */
	    	  INTO TB_EV_APO
	    		(
	    			UNTY_YN
	    		  , UO_NM
	    		  , UO_BRNO
	    		  , UNTY_YR

	    		  , SYS_FRST_INPT_DT
	    		  , SYS_FRST_INPT_USER_ID
	    		  , SYS_FRST_INPT_PRGRM_ID
	    		  , SYS_LAST_CHG_DT
	    		  , SYS_LAST_CHG_USER_ID
	    		  , SYS_LAST_CHG_PRGRM_ID
	    		)
	   		VALUES
	   			(
	   			    #{untyYn}
	   			  , #{uoNm}
	   			  , #{uoBrno}
	   			  , #{untyYr}

	   			  , SYSDATE
	   			  , #{sysFrstInptUserId}
	   			  , #{sysFrstInptPrgrmId}
	   			  , SYSDATE
	   			  , #{sysLastChgUserId}
	   			  , #{sysLastChgPrgrmId}
	   			)
    	]]>
    </insert>
	<update id="updatePrdcrCrclOgnReqMng" parameterType="com.at.apcss.pd.aom.vo.PrdcrCrclOgnReqMngVO">
    	<![CDATA[
	    	UPDATE /* com.at.apcss.pd.aom.mapper.PrdcrCrclOgnReqMngMapper.upatePrdcrCrclOgnReqMng */
	    		TB_EV_APO
			   SET
			 	  UNTY_YN		= #{untyYn}
			 	, UO_NM 		= #{uoNm}
			 	, UO_BRNO 		= #{uoBrno}
			 	, UNTY_YR 		= #{untyYr}
			 	, APRV			= #{aprv}
			 	, ISO_HLD_YN 	= #{isoHldYn}
    	]]>
    	<![CDATA[
				, SYS_LAST_CHG_DT		= SYSDATE
	    		, SYS_LAST_CHG_USER_ID	= #{sysLastChgUserId}
	    		, SYS_LAST_CHG_PRGRM_ID	= #{sysLastChgPrgrmId}

			 WHERE 1=1
			   AND APO_CD	= #{apoCd}
    	]]>
    </update>


	<delete id="deletePrdcrCrclOgnReqMng" parameterType="com.at.apcss.pd.aom.vo.PrdcrCrclOgnReqMngVO">
		<![CDATA[
		DELETE FROM TB_PD_PrdcrCrclOgnVluIdctrMng
		 WHERE TEST_NO 	= #{testNo}
		]]>
	</delete>





	<insert id="insertEvAplyMng" parameterType="com.at.apcss.pd.aom.vo.PrdcrCrclOgnReqMngVO">
	<![CDATA[
    	MERGE INTO TB_EV_APLY_MNG CLT  /* com.at.apcss.pd.aom.mapper.PrdcrCrclOgnReqMngMapper.insertEvAplyMng */
		USING DUAL
			ON (
				CLT.APO_CD  = #{apoCd}
				)
		WHEN MATCHED THEN
				 UPDATE /* com.at.apcss.pd.aom.mapper.PrdcrCrclOgnReqMngMapper.insertEvAplyMng */
					   SET
		    	          RAW_MTR_ENSR_SIGUN_CNT	= #{rawMtrEnsrSigunCnt}
		    	        , RAW_MTR_ENSR_CTPV_CNT		= #{rawMtrEnsrCtpvCnt}
		    	        , CTPV_NM					= #{ctpvNm}
		    	        , SIGUN_NM					= #{sigunNm}
		    	        , PRUO_FUND_APLY_AMT		= #{pruoFundAplyAmt}
		    	        , ISO_FUND_APLY_AMT			= #{isoFundAplyAmt}
		    	        , APLY_TRGT_SE				= #{aplyTrgtSe}
		    	]]>
		    	<![CDATA[

					 WHERE 1=1
					 AND CLT.APO_CD		= #{apoCd}
		WHEN NOT MATCHED THEN
			 INSERT /* com.at.apcss.pd.aom.mapper.PrdcrCrclOgnReqMngMapper.insertEvAplyMng */
		    		(
		    			APO_CD
		    		  , APO_SE
		    		  , BRNO
		    		  , CRNO
		    		  , CORP_NM
		    		  , YR
		    		  , APLY_DAY
		    		  , RAW_MTR_ENSR_SIGUN_CNT
		    		  , RAW_MTR_ENSR_CTPV_CNT
		    		  , CTPV_NM
		    		  , SIGUN_NM
		    		  , PRUO_FUND_APLY_AMT
		    		  , ISO_FUND_APLY_AMT
		    		  , APLY_TRGT_SE
		    		)
		   		VALUES
		   			(
		   			    #{apoCd}
		   			  , #{apoSe}
		   			  , #{brno}
		   			  , #{crno}
		   			  , #{corpNm}
		   			  TO_CHAR(SYSDATE,'YYYY')
		   			  , SYSDATE
		   			  , #{rawMtrEnsrSigunCnt}
		   			  , #{rawMtrEnsrCtpvCnt}
		   			  , #{ctpvNm}
		   			  , #{sigunNm}
		   			  , #{pruoFundAplyAmt}
		   			  , #{isoFundAplyAmt}
		   			  , #{aplyTrgtSe}
		   			)
    	]]>
	</insert>


	<insert id="insertGpc" parameterType="com.at.apcss.pd.aom.vo.GpcVO">
	<![CDATA[
    	MERGE INTO TB_EV_APO_YR_GPC_CD CLT  /* com.at.apcss.pd.aom.mapper.PrdcrCrclOgnReqMngMapper.insertGpc */
		USING DUAL
			ON (
					CLT.APO_CD  	= #{apoCd}
				AND CLT.YR  		= #{yr}
				AND CLT.CTGRY_CD  	= #{ctgryCd}
				AND CLT.ITEM_CD  	= #{itemCd}
				AND CLT.STTG_UPBR_ITEM_SE  	= #{sttgUpbrItemSe}
				)
		WHEN MATCHED THEN
				 UPDATE /* com.at.apcss.pd.aom.mapper.PrdcrCrclOgnReqMngMapper.insertGpc */
					   SET
		    	          RMRK	= #{rmrk}
		    	]]>
				<if test='delYn != null and delYn != ""'>
						, DEL_YN 	= #{delYn}
				</if>
		    	<![CDATA[
						, SYS_LAST_CHG_DT		= SYSDATE
			    		, SYS_LAST_CHG_USER_ID	= #{sysLastChgUserId}
			    		, SYS_LAST_CHG_PRGRM_ID	= #{sysLastChgPrgrmId}
					 WHERE 1=1
					 AND CLT.APO_CD  	= #{apoCd}
					 AND CLT.YR  		= #{yr}
					 AND CLT.CTGRY_CD  	= #{ctgryCd}
					 AND CLT.ITEM_CD  	= #{itemCd}
					 AND CLT.STTG_UPBR_ITEM_SE  = #{sttgUpbrItemSe}
		WHEN NOT MATCHED THEN
			 INSERT /* com.at.apcss.pd.aom.mapper.PrdcrCrclOgnReqMngMapper.insertGpc */
		    		(
		    			APO_CD
		    		  , APO_SE
		    		  , BRNO
		    		  , CRNO
		    		  , CORP_NM

		    		  , YR
		    		  , STTG_UPBR_ITEM_SE
		    		  , CTGRY_CD
		    		  , CTGRY_NM
		    		  , ITEM_CD
		    		  , ITEM_NM
		    		  , RMRK

		    		  , SYS_FRST_INPT_DT
		    		  , SYS_FRST_INPT_USER_ID
		    		  , SYS_FRST_INPT_PRGRM_ID
		    		  , SYS_LAST_CHG_DT
		    		  , SYS_LAST_CHG_USER_ID
		    		  , SYS_LAST_CHG_PRGRM_ID
		    		)
		   		VALUES
		   			(
		   			    #{apoCd}
		   			  , #{apoSe}
		   			  , #{brno}
		   			  , #{crno}
		   			  , #{corpNm}

		   			  , TO_CHAR(SYSDATE,'YYYY')
		   			  , #{sttgUpbrItemSe}
		   			  , #{ctgryCd}
		   			  , (SELECT CD_VL_NM FROM TB_COM_CD_DTL WHERE CD_ID = 'CTGRY_CD' AND CD_VL = #{ctgryCd})
		   			  , #{itemCd}
		   			  , #{itemNm}
		   			  , #{rmrk}

		   			  , SYSDATE
		   			  , #{sysFrstInptUserId}
		   			  , #{sysFrstInptPrgrmId}
		   			  , SYSDATE
		   			  , #{sysLastChgUserId}
		   			  , #{sysLastChgPrgrmId}
		   			)
    	]]>
	</insert>

	<select id="selectGpcList" parameterType="com.at.apcss.pd.aom.vo.GpcVO" resultType="com.at.apcss.pd.aom.vo.GpcVO">
    	<![CDATA[
			SELECT /* com.at.apcss.pd.aom.mapper.PrdcrCrclOgnReqMngMapper.selectGpcList */
				  CM.APO_CD
				, CM.APO_SE
				, CM.CORP_NM
				, CM.BRNO
				, CM.CRNO

				, CM.YR
				, CM.STTG_UPBR_ITEM_SE
				, CM.CTGRY_CD
				, CM.CTGRY_NM
				, CM.ITEM_CD
				, CM.ITEM_NM
				, CM.RMRK

				, CM.SYS_FRST_INPT_DT		AS SYS_FRST_INPT_DT
				, TO_CHAR(CM.SYS_FRST_INPT_DT,'YYYY-MM-DD')		AS SYS_FRST_INPT_DT_YMD
				, CM.SYS_FRST_INPT_USER_ID	AS SYS_FRST_INPT_USER_ID
				, (SELECT USER_NM FROM TB_COM_USER WHERE USER_ID = CM.SYS_FRST_INPT_USER_ID) AS SYS_FRST_INPT_USER_NM
				, CM.SYS_FRST_INPT_PRGRM_ID	AS SYS_FRST_INPT_PRGRM_ID

				, CM.SYS_LAST_CHG_DT		AS SYS_LAST_CHG_DT
				, TO_CHAR(CM.SYS_LAST_CHG_DT,'YYYY-MM-DD')		AS SYS_LAST_CHG_DT_YMD
				, CM.SYS_LAST_CHG_USER_ID	AS SYS_LAST_CHG_USER_ID
				, (SELECT USER_NM FROM TB_COM_USER WHERE USER_ID = CM.SYS_LAST_CHG_USER_ID) AS SYS_LAST_CHG_USER_NM
				, CM.SYS_LAST_CHG_PRGRM_ID	AS SYS_LAST_CHG_PRGRM_ID
			  FROM TB_EV_APO_YR_GPC_CD CM
			 WHERE 1=1
    	]]>
			<if test='apoCd != null and apoCd != ""'>
				AND CM.APO_CD = #{apoCd}
			</if>
			<if test='apoSe != null and apoSe != ""'>
				AND CM.APO_SE = #{apoSe}
			</if>
			<if test='brno != null and brno != ""'>
				AND CM.BRNO = #{brno}
			</if>
			<if test='crno != null and crno != ""'>
				AND CM.CRNO = #{crno}
			</if>
			<if test='corpNm != null and corpNm != ""'>
				AND CM.CORP_NM LIKE '%' || #{corpNm} || '%'
			</if>
			<if test='yr != null and yr != ""'>
				AND EAM.YR = #{yr}
			</if>
		ORDER BY CM.SYS_LAST_CHG_DT DESC
    </select>
</mapper>


