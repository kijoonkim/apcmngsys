<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- ==========================================================================	-->
<!-- NAME : UoGenalTblHisPopupMapper.xml                                    		-->
<!-- DESC : 통합조직 총괄표 과거조회 mapper                                             		-->
<!-- ==========================================================================	-->
<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
<!-- ===========  	============  	===========================================	-->
<!-- 2025.01.10  	ljw        		Initial Creation                            -->
<!-- ==========================================================================	-->

<mapper namespace="com.at.apcss.pd.hisPopup.mapper.UoGenalTblHisPopupMapper">

	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.pd.hisPopup.mapper.UoGenalTblHisPopupMapper.selectHisUoGenalTbl2024	-->
	<!-- DESC : 통합조직 총괄표 조회 2024년                                     			-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2025.01.10  	ljw        		Initial Creation                            -->
	<!-- ==========================================================================	-->
	<select id="selectHisUoGenalTbl2024" parameterType="com.at.apcss.pd.hisPopup.vo.UoGenalTblVO" resultType="com.at.apcss.pd.hisPopup.vo.UoGenalTblVO">
		SELECT
			ITEM.ITEM_CD
			, ITEM.ITEM_NM
			, ITEM.STTG_UPBR_ITEM_SE
			, ITEM.STTG_UPBR_ITEM_NM
			, ITEM.CTGRY_CD
			, ITEM.CTGRY_NM
			, ITEM.BRNO
			, ITEM.YR
			, (SELECT APRV FROM TB_EV_APO WHERE BRNO = ITEM.BRNO) AS APRV
			,(SELECT CD_VL_NM FROM TB_COM_CD_DTL WHERE CD_ID = 'APRV_UPBR_SE_CD' AND CD_VL = (SELECT APRV FROM TB_EV_APO WHERE BRNO = ITEM.BRNO)) AS APRV_NM
			, (SELECT CORP_NM FROM TB_EV_APO_HSTRY WHERE BRNO = ITEM.BRNO AND YR = ITEM.YR) AS CORP_NM

			, TOTA.SLS_CNSGN_SLS_AMT 			AS SLS_CNSGN_SLS_AMT

			, TOTB.SLS_CNSGN_SLS_AMT 			AS SLS_CNSGN_SLS_AMT_TOT

			, ROUND(NVL( TOTA.SLS_CNSGN_SLS_AMT  / NULLIF( TOTB.SLS_CNSGN_SLS_AMT  , 0 ) , 0 ) * 100 , 2 ) AS SLS_CNSGN_SLS_AMT_RT
			, (SELECT STBLT_YN
				FROM TB_EV_UO_ISO_PRCHS_PRCHS_SLS_TOT
				WHERE 1=1
				  AND APO_SE = '1'
				  AND TYPE_SE_NO ='8'
				  AND BRNO = ITEM.BRNO
				  AND YR = ITEM.YR
				  AND ITEM_CD = ITEM.ITEM_CD
			) AS STBLT_YN
		FROM
			(SELECT
					ITEM_CD
					, YR
					, STTG_UPBR_ITEM_SE
					, CTGRY_CD
					, TO_CHAR(BRNO) AS BRNO
					,(SELECT ITEM_NM FROM TB_ITEM_CRTR WHERE ITEM_CD = AYGC.ITEM_CD) AS ITEM_NM
					,(SELECT CD_VL_NM FROM TB_COM_CD_DTL WHERE CD_ID = 'CTGRY_CD' AND CD_VL = AYGC.CTGRY_CD) AS CTGRY_NM
					,(SELECT CD_VL_NM FROM TB_COM_CD_DTL WHERE CD_ID = 'STTG_UPBR_ITEM_SE' AND CD_VL = AYGC.STTG_UPBR_ITEM_SE) AS STTG_UPBR_ITEM_NM
				FROM TB_EV_APO_YR_GPC_CD AYGC
				WHERE 1=1
				  AND BRNO = #{brno}
				  AND YR = #{yr}
			) ITEM ,
			(SELECT
					BRNO
					, ITEM_CD
					, SUM( NVL( SLS_CNSGN_SLS_AMT , 0 ) ) AS SLS_CNSGN_SLS_AMT
				FROM TB_EV_UO_ISO_PRCHS_PRCHS_SLS_TOT PSTA
				WHERE 1=1
				  AND APO_SE = '1'
				  AND TYPE_SE_NO IN ('2','6')
				  AND (
						(PRDCR_OGNZ_SN IN (SELECT PRDCR_OGNZ_SN
											FROM TB_EV_FRMHS_APO
											WHERE 1=1
											  AND STBLT_YN = 'Y'
											  AND NVL(EXCL_YN,'N') != 'Y'
											  AND APO_SE = '1'
											  AND BRNO = PSTA.BRNO
											  AND YR = PSTA.YR
											)
						)OR
						(PRDCR_OGNZ_SN = '0')
					)
				  AND BRNO = #{brno}
				  AND YR = #{yr}

				GROUP BY  BRNO , ITEM_CD
			) TOTA ,
			(SELECT
					BRNO
					, ITEM_CD
					, SUM( NVL( SLS_CNSGN_SLS_AMT , 0 ) ) AS SLS_CNSGN_SLS_AMT
				FROM TB_EV_UO_ISO_PRCHS_PRCHS_SLS_TOT PSTB
				WHERE 1=1
				  AND APO_SE = '1'
				  AND TYPE_SE_NO IN ('2','3','6','7')
				  AND (
						(PRDCR_OGNZ_SN IN (SELECT PRDCR_OGNZ_SN
											FROM TB_EV_FRMHS_APO
											WHERE 1=1
											  AND STBLT_YN = 'Y'
											  AND NVL(EXCL_YN,'N') != 'Y'
											  AND APO_SE = '1'
											  AND BRNO = PSTB.BRNO
											  AND YR = PSTB.YR
											)
						)OR
						(PRDCR_OGNZ_SN = '0')
					)
				  AND BRNO = #{brno}
				  AND YR = #{yr}

				GROUP BY  BRNO , ITEM_CD
			) TOTB
		WHERE 1=1
		  AND ITEM.ITEM_CD = TOTA.ITEM_CD(+)
		  AND ITEM.ITEM_CD = TOTB.ITEM_CD(+)
	</select>

	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.pd.hisPopup.mapper.UoGenalTblHisPopupMapper.selectHisUoGenalTbl2025	-->
	<!-- DESC : 통합조직 총괄표 조회 2025년                                     			-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2025.01.10  	ljw        		Initial Creation                            -->
	<!-- ==========================================================================	-->
	<select id="selectHisUoGenalTbl2025" parameterType="com.at.apcss.pd.hisPopup.vo.UoGenalTblVO" resultType="com.at.apcss.pd.hisPopup.vo.UoGenalTblVO">
		SELECT
			ITEM.ITEM_CD
			, ITEM.ITEM_NM
			, ITEM.STTG_UPBR_ITEM_SE
			, ITEM.STTG_UPBR_ITEM_NM
			, ITEM.CTGRY_CD
			, ITEM.CTGRY_NM
			, ITEM.BRNO
			, ITEM.YR
			, (SELECT APRV FROM TB_EV_APO WHERE BRNO = ITEM.BRNO) AS APRV
			,(SELECT CD_VL_NM FROM TB_COM_CD_DTL WHERE CD_ID = 'APRV_UPBR_SE_CD' AND CD_VL = (SELECT APRV FROM TB_EV_APO WHERE BRNO = ITEM.BRNO)) AS APRV_NM
			, (SELECT CORP_NM FROM TB_EV_APO_HSTRY WHERE BRNO = ITEM.BRNO AND YR = ITEM.YR) AS CORP_NM

			, TOTA.SLS_CNSGN_SLS_AMT 			AS SLS_CNSGN_SLS_AMT

			, TOTB.SLS_CNSGN_SLS_AMT 			AS SLS_CNSGN_SLS_AMT_TOT

			, TOTA.SLS_CNSGN_SLS_VLM 			AS SLS_CNSGN_SLS_VLM

			, TOTB.SLS_CNSGN_SLS_VLM 			AS SLS_CNSGN_SLS_VLM_TOT

			, ROUND(NVL( TOTA.SLS_CNSGN_SLS_AMT  / NULLIF( TOTB.SLS_CNSGN_SLS_AMT  , 0 ) , 0 ) * 100 , 2 ) AS SLS_CNSGN_SLS_AMT_RT
			, (SELECT STBLT_YN
				FROM TB_EV_UO_ISO_PRCHS_PRCHS_SLS_TOT
				WHERE 1=1
				  AND DEL_YN = 'N'
				  AND APO_SE = '1'
				  AND TYPE_SE_NO ='8'
				  AND NVL(TMPR_STRG_YN,'N') = 'N'
				  AND BRNO = ITEM.BRNO
				  AND YR = ITEM.YR
				  AND ITEM_CD = ITEM.ITEM_CD
			) AS STBLT_YN
		FROM
			(SELECT
					ITEM_CD
					, YR
					, STTG_UPBR_ITEM_SE
					, CTGRY_CD
					, TO_CHAR(BRNO) AS BRNO
					,(SELECT ITEM_NM FROM TB_ITEM_CRTR WHERE ITEM_CD = AYGC.ITEM_CD) AS ITEM_NM
					,(SELECT CD_VL_NM FROM TB_COM_CD_DTL WHERE CD_ID = 'CTGRY_CD' AND CD_VL = AYGC.CTGRY_CD) AS CTGRY_NM
					,(SELECT CD_VL_NM FROM TB_COM_CD_DTL WHERE CD_ID = 'STTG_UPBR_ITEM_SE' AND CD_VL = AYGC.STTG_UPBR_ITEM_SE) AS STTG_UPBR_ITEM_NM
				FROM TB_EV_APO_YR_GPC_CD AYGC
				WHERE 1=1
				  AND STTG_UPBR_ITEM_SE != '3'
				  AND APO_SE = '1'
				  AND BRNO = #{brno}
				  AND YR = #{yr}
			) ITEM ,
			(SELECT
					BRNO
					, ITEM_CD
					, SUM( NVL( SLS_CNSGN_SLS_VLM , 0 ) ) AS SLS_CNSGN_SLS_VLM
					, SUM( NVL( SLS_CNSGN_SLS_AMT , 0 ) ) AS SLS_CNSGN_SLS_AMT
				FROM TB_EV_UO_ISO_PRCHS_PRCHS_SLS_TOT PSTA
				WHERE 1=1
				  AND DEL_YN = 'N'
				  AND APO_SE = '1'
				  AND TYPE_SE_NO IN ('1','5')
				  AND NVL(TMPR_STRG_YN,'N') = 'N'
				  AND OGNZ_STBLT_YN = 'Y'
				  AND ITEM_CD IN (SELECT ITEM_CD
								FROM TB_EV_APO_YR_GPC_CD
								WHERE 1=1
								  AND APO_SE = '1'
								  AND YR = PSTA.YR
								  AND BRNO = PSTA.BRNO
								  AND STTG_UPBR_ITEM_SE != '3'
								)
				AND (
						(PRDCR_OGNZ_SN IN (SELECT PRDCR_OGNZ_SN
											FROM TB_EV_FRMHS_APO
											WHERE 1=1
											  AND STBLT_YN = 'Y'
											  AND NVL(EXCL_YN,'N') != 'Y'
											  AND APO_SE = '1'
											  AND YR = PSTA.YR
											  AND BRNO = PSTA.BRNO
											  AND TRMT_TYPE = PSTA.TRMT_TYPE
											)
						)OR
						(PRDCR_OGNZ_SN = '0')
					)
				  AND BRNO = #{brno}
				  AND YR = #{yr}
				GROUP BY BRNO, ITEM_CD
			) TOTA ,
			(SELECT
					BRNO
					, ITEM_CD
					, SUM( NVL( SLS_CNSGN_SLS_VLM , 0 ) ) AS SLS_CNSGN_SLS_VLM
					, SUM( NVL( SLS_CNSGN_SLS_AMT , 0 ) ) AS SLS_CNSGN_SLS_AMT
				FROM TB_EV_UO_ISO_PRCHS_PRCHS_SLS_TOT PSTB
				WHERE 1=1
				  AND DEL_YN = 'N'
				  AND APO_SE = '1'
				  AND NVL(TMPR_STRG_YN,'N') = 'N'
				  AND ITEM_CD IN (SELECT ITEM_CD
									FROM TB_EV_APO_YR_GPC_CD
									WHERE 1=1
									  AND APO_SE = '1'
									  AND YR = PSTB.YR
									  AND BRNO = PSTB.BRNO
									  AND STTG_UPBR_ITEM_SE != '3'
									)
				  AND TYPE_SE_NO = '8'
				  AND BRNO = #{brno}
				  AND YR = #{yr}
				GROUP BY BRNO, ITEM_CD
			) TOTB
		WHERE 1=1
		  AND ITEM.ITEM_CD = TOTA.ITEM_CD(+)
		  AND ITEM.ITEM_CD = TOTB.ITEM_CD(+)
	</select>

	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.pd.hisPopup.mapper.UoGenalTblHisPopupMapper.selectHisUoGenalTbl2025	-->
	<!-- DESC : 통합조직 부류별 합계 조회 2025년                                     			-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2025.01.10  	ljw        		Initial Creation                            -->
	<!-- ==========================================================================	-->
	<select id="selectHisUoClsfTot2025" parameterType="com.at.apcss.pd.hisPopup.vo.UoGenalTblVO" resultType="com.at.apcss.pd.hisPopup.vo.UoGenalTblVO">
		SELECT	/* com.at.apcss.pd.pcom.mapper.PrdcrCrclOgnGenalTblMngMapper.selectIsoClsfTot */
			BRNO
			, (CASE WHEN CLSF_CD IN ('2', '3', '4') THEN '원예농산물'
				ELSE '기타품목'
				END
			) AS CLSF_SE_NM
			, (CASE WHEN CLSF_CD IN ('2', '3', '4') THEN '1'
				ELSE '2'
				END
			) AS CLSF_SE_CD
			, CLSF_CD
			, (SELECT CD_VL_NM FROM TB_COM_CD_DTL WHERE CD_ID = 'CLSF_CD' AND CD_VL = A.CLSF_CD) AS CLSF_NM
			, SUM( NVL( DECODE(YR,#{yr}-1,SLS_TRST_VLM,'') , 0 ) + NVL( DECODE(YR,#{yr}-1,SLS_EMSPAP_VLM,'') , 0 ) ) AS PRV_TOT_VLM
			, SUM( NVL( DECODE(YR,#{yr}-1,SLS_TRST_AMT,'') , 0 ) + NVL( DECODE(YR,#{yr}-1,SLS_EMSPAP_AMT,'') , 0 ) ) AS PRV_TOT_AMT

			, SUM( NVL( DECODE(YR,#{yr},SLS_TRST_VLM,'') , 0 ) + NVL( DECODE(YR,#{yr},SLS_EMSPAP_VLM,'') , 0 ) ) AS TOT_VLM
			, SUM( NVL( DECODE(YR,#{yr},SLS_TRST_AMT,'') , 0 ) + NVL( DECODE(YR,#{yr},SLS_EMSPAP_AMT,'') , 0 ) ) AS TOT_AMT
		FROM (
				SELECT
					YR
					, #{brno} AS BRNO
					, SLS_TRST_VLM
					, SLS_TRST_AMT
					, SLS_EMSPAP_VLM
					, SLS_EMSPAP_AMT
					,(SELECT CLSF_CD
						FROM TB_EV_APO_YR_GPC_CD
						WHERE 1=1
						  AND APO_SE = '1'
						  AND YR = APS.YR
						  AND BRNO = APS.BRNO
						  AND ITEM_CD = APS.ITEM_CD
						  AND STTG_UPBR_ITEM_SE = APS.STTG_UPBR_ITEM_SE
					) AS CLSF_CD
				FROM TB_EV_UO_ISO_ALL_PRCHS_SLS APS
				WHERE 1=1
				  AND ITEM_CD = (SELECT ITEM_CD
				  					FROM TB_EV_APO_YR_GPC_CD
				  					WHERE 1=1
				  					  AND APO_SE = '1'
				  					  AND YR = APS.YR
				  					  AND BRNO = APS.BRNO
				  					  AND ITEM_CD = APS.ITEM_CD
				  					  AND STTG_UPBR_ITEM_SE = APS.STTG_UPBR_ITEM_SE)
				  AND APO_SE = '1'
				  AND PRCHS_SLS_SE = '2'
				  AND (
				  		BRNO = #{brno}
				  		OR
				  		BRNO IN (SELECT BRNO FROM TB_EV_BRNO_MNG WHERE BRNO != 0 AND MNG_NO IN (SELECT MNG_NO FROM TB_EV_BRNO_MNG WHERE BRNO = #{brno}))
				  		)
				) A
		GROUP BY  BRNO , CLSF_CD

		UNION ALL

		SELECT	/* com.at.apcss.pd.pcom.mapper.PrdcrCrclOgnGenalTblMngMapper.selectIsoClsfTot */
			BRNO
			, DECODE(CLSF_SE_CD, '1' , '원예농산물' , '기타품목') AS CLSF_SE_NM
			, CLSF_SE_CD
			, '' AS CLSF_CD
			, '소계' AS CLSF_NM
			, SUM( NVL( DECODE(YR,#{yr}-1,SLS_TRST_VLM,'') , 0 ) + NVL( DECODE(YR,#{yr}-1,SLS_EMSPAP_VLM,'') , 0 ) ) AS PRV_TOT_VLM
			, SUM( NVL( DECODE(YR,#{yr}-1,SLS_TRST_AMT,'') , 0 ) + NVL( DECODE(YR,#{yr}-1,SLS_EMSPAP_AMT,'') , 0 ) ) AS PRV_TOT_AMT

			, SUM( NVL( DECODE(YR,#{yr},SLS_TRST_VLM,'') , 0 ) + NVL( DECODE(YR,#{yr},SLS_EMSPAP_VLM,'') , 0 ) ) AS TOT_VLM
			, SUM( NVL( DECODE(YR,#{yr},SLS_TRST_AMT,'') , 0 ) + NVL( DECODE(YR,#{yr},SLS_EMSPAP_AMT,'') , 0 ) ) AS TOT_AMT
		FROM (
				SELECT
					YR
					, #{brno} AS BRNO
					, SLS_TRST_VLM
					, SLS_TRST_AMT
					, SLS_EMSPAP_VLM
					, SLS_EMSPAP_AMT
					,(SELECT CASE WHEN CLSF_CD IN ('2', '3', '4') THEN '1'
									ELSE '2'
									END
						FROM TB_EV_APO_YR_GPC_CD
						WHERE 1=1
						  AND APO_SE = '1'
						  AND YR = APS.YR
						  AND BRNO = APS.BRNO
						  AND ITEM_CD = APS.ITEM_CD
						  AND STTG_UPBR_ITEM_SE = APS.STTG_UPBR_ITEM_SE
					) AS CLSF_SE_CD
				FROM TB_EV_UO_ISO_ALL_PRCHS_SLS APS
				WHERE 1=1
				  AND ITEM_CD = (SELECT ITEM_CD
				  					FROM TB_EV_APO_YR_GPC_CD
				  					WHERE 1=1
				  					  AND APO_SE = '1'
				  					  AND YR = APS.YR
				  					  AND BRNO = APS.BRNO
				  					  AND ITEM_CD = APS.ITEM_CD
				  					  AND STTG_UPBR_ITEM_SE = APS.STTG_UPBR_ITEM_SE)
				  AND APO_SE = '1'
				  AND PRCHS_SLS_SE = '2'
				  AND (
				  		BRNO = #{brno}
				  		OR
				  		BRNO IN (SELECT BRNO FROM TB_EV_BRNO_MNG WHERE BRNO != 0 AND MNG_NO IN (SELECT MNG_NO FROM TB_EV_BRNO_MNG WHERE BRNO = #{brno}))
				  		)

				) A
		GROUP BY  BRNO , CLSF_SE_CD

		ORDER BY CLSF_SE_CD,CLSF_CD
	</select>
</mapper>