<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- ==========================================================================	-->
<!-- NAME : FcltInstlInfoMapper.xml                                    				-->
<!-- DESC : 시설설치보완 정보 mapper                                             			-->
<!-- ==========================================================================	-->
<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
<!-- ===========  	============  	===========================================	-->
<!-- 2023.06.29  	jcshin        	Initial Creation                            -->
<!-- ==========================================================================	-->

<mapper namespace="com.at.apcss.fm.fclt.mapper.FcltInstlInfoMapper">

	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.fm.fclt.mapper.FcltInstlInfoMapper.selectFcltInstlInfo				-->
	<!-- DESC : 시설설치보완 테이블 단건조회.                                             		-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.06.29  	jcshin        	Initial Creation                            -->
	<!-- ==========================================================================	-->
	<select id="selectFcltInstlInfo" parameterType="com.at.apcss.fm.fclt.vo.FcltInstlInfoVO" resultType="com.at.apcss.fm.fclt.vo.FcltInstlInfoVO">
		<![CDATA[
			SELECT /* com.at.apcss.fm.fclt.mapper.FcltInstlInfoMapper.selectFcltInstlInfoList */
				AFIS.SN
				, AFIS.BIZ_YR
				, AFIS.APC_CD
				, AFIS.APC_NM
				, AFIS.SPRT_BIZ
				, AFIS.BIZ_CN
				, AFIS.NE
				, AFIS.LCLT_EXPND
				, AFIS.SLF_BRDN
				, AFIS.BIZ_NM
				, AFIS.BIZ_CD
				, AFIS.LCLT_EXPND_CTPV
				, AFIS.LCLT_EXPND_SGG

			FROM TB_TE_APC_FCLT_INSTL_SPLMNT AFIS
			WHERE 1=1
			  AND AFIS.DEL_YN = 'N'
			 ]]>
			<if test='apcCd != null and !apcCd.equals("")'>
			  AND AFIS.APC_CD = #{apcCd}
			</if>
			ORDER BY AFIS.BIZ_YR , SPRT_BIZ , BIZ_NM
	</select>
	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.fm.fclt.mapper.FcltInstlInfoMapper.selectFcltInstlInfoList	-->
	<!-- DESC : 시설설치보완 테이블 목록 조회.                                             		-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.06.29  	jcshin        	Initial Creation                            -->
	<!-- ==========================================================================	-->
	<select id="selectFcltInstlInfoList" parameterType="com.at.apcss.fm.fclt.vo.FcltInstlInfoVO" resultType="com.at.apcss.fm.fclt.vo.FcltInstlInfoVO">
		<!-- Start 페이징 -->
		<if test='pagingYn != null and pagingYn.equals("Y")'>
			SELECT
				  ROWNUM AS ROW_SEQ
				, COUNT(*) OVER() AS TOTAL_RECORD_COUNT
				, pt0.*
			  FROM (
		</if>
		<!-- End 페이징 -->

		<![CDATA[
			SELECT /* com.at.apcss.fm.fclt.mapper.FcltInstlInfoMapper.selectFcltInstlInfoList */
				AFIS.SN
				, AFIS.BIZ_YR
				, AFIS.APC_CD
				, AFIS.APC_NM
				, AFIS.SPRT_BIZ
				, AFIS.BIZ_CN
				, AFIS.NE
				, AFIS.LCLT_EXPND
				, AFIS.SLF_BRDN
				, AFIS.BIZ_NM
				, AFIS.BIZ_CD
				, AFIS.LCLT_EXPND_CTPV
				, AFIS.LCLT_EXPND_SGG

			FROM TB_TE_APC_FCLT_INSTL_SPLMNT AFIS
			WHERE 1=1
			  AND AFIS.DEL_YN = 'N'
			  AND AFIS.BIZ_YR IS NOT NULL
			 ]]>
			<if test='apcCd != null and !apcCd.equals("")'>
			  AND AFIS.APC_CD = #{apcCd}
			</if>
			ORDER BY AFIS.BIZ_YR , SPRT_BIZ , BIZ_NM

		<!-- Start 페이징 -->
		<if test='pagingYn != null and pagingYn.equals("Y")'>
			  ) pt0
			OFFSET (#{currentPageNo} - 1) * #{recordCountPerPage} ROWS
			FETCH FIRST #{recordCountPerPage} ROWS ONLY
		</if>
		<!-- End 페이징 -->
	</select>

	<insert id="insertFcltInstlInfo" parameterType="com.at.apcss.fm.fclt.vo.FcltInstlInfoVO">
		MERGE INTO TB_TE_APC_FCLT_INSTL_SPLMNT AFIS /* com.at.apcss.fm.fclt.mapper.FcltInstlInfoMapper.insertFcltInstlInfo */
		USING DUAL
		ON (
			AFIS.APC_CD = #{apcCd}
			AND AFIS.SN = #{sn}
			)
		WHEN MATCHED THEN
		  UPDATE SET
				BIZ_YR					= #{bizYr}
				, SPRT_BIZ				= #{sprtBiz}
				, BIZ_CN				= #{bizCn}
				, BIZ_NM				= #{bizNm}
				, BIZ_CD				= #{bizCd}
				, NE					= #{ne}
				, LCLT_EXPND			= #{lcltExpnd}
				, SLF_BRDN				= #{slfBrdn}
				, LCLT_EXPND_CTPV		= #{lcltExpndCtpv}
				, LCLT_EXPND_SGG		= #{lcltExpndSgg}

				, SYS_LAST_CHG_DT		=  SYSDATE
				, SYS_LAST_CHG_USER_ID	=  #{sysLastChgUserId}
				, SYS_LAST_CHG_PRGRM_ID	=  #{sysLastChgPrgrmId}
		WHEN NOT MATCHED THEN
		  INSERT (
					SN
					, BIZ_YR
					, APC_CD
					, APC_NM
					, SPRT_BIZ
					, BIZ_CN
					, BIZ_NM
					, BIZ_CD
					, NE
					, LCLT_EXPND
					, SLF_BRDN
					, LCLT_EXPND_CTPV
					, LCLT_EXPND_SGG

					, SYS_FRST_INPT_DT
					, SYS_FRST_INPT_USER_ID
					, SYS_FRST_INPT_PRGRM_ID
					, SYS_LAST_CHG_DT
					, SYS_LAST_CHG_USER_ID
					, SYS_LAST_CHG_PRGRM_ID
				  )
			VALUES
				(
				<choose>
					<when test='sn != null and !sn.equals("")'>
					#{sn}
					</when>
					<otherwise>
					(SELECT NVL(MAX(SN),0)+1 FROM TB_TE_APC_FCLT_INSTL_SPLMNT WHERE APC_CD = #{apcCd})
					</otherwise>
				</choose>
					, #{bizYr}
					, #{apcCd}
					, #{apcNm}
					, #{sprtBiz}
					, #{bizCn}
					, #{bizNm}
					, #{bizCd}
					, #{ne}
					, #{lcltExpnd}
					, #{slfBrdn}
					, #{lcltExpndCtpv}
					, #{lcltExpndSgg}

					, SYSDATE
					, #{sysFrstInptUserId}
					, #{sysFrstInptPrgrmId}
					, SYSDATE
					, #{sysLastChgUserId}
					, #{sysLastChgPrgrmId}
				)
	</insert>

	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.fm.fclt.mapper.FcltInstlInfoMapper.insertFcltInstlInfo				-->
	<!-- DESC : 시설설치보완 등록                                             				-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.06.09  	kimho        	Initial Creation                            -->
	<!-- ==========================================================================	-->
	<!--
	<insert id="insertFcltInstlInfo" parameterType="com.at.apcss.fm.fclt.vo.FcltInstlInfoVO">
		<![CDATA[
			INSERT /* com.at.apcss.fm.fclt.mapper.FcltInstlInfoMapper.insertFcltInstlInfo */
			  INTO TB_TE_APC_FCLT_INSTL_SPLMNT
				(
					SN
					, BIZ_YR
					, APC_CD
					, APC_NM
					, SPRT_BIZ
					, BIZ_CN
					, BIZ_NM
					, BIZ_CD
					, NE
					, LCLT_EXPND
					, SLF_BRDN
					, LCLT_EXPND_CTPV
					, LCLT_EXPND_SGG

					, SYS_FRST_INPT_DT
					, SYS_FRST_INPT_USER_ID
					, SYS_FRST_INPT_PRGRM_ID
					, SYS_LAST_CHG_DT
					, SYS_LAST_CHG_USER_ID
					, SYS_LAST_CHG_PRGRM_ID
				  )
			VALUES
				(
					(SELECT MAX(SN) FROM TB_TE_APC_FCLT_INSTL_SPLMNT WHERE APC_CD = #{apcCd})
					, #{bizYr}
					, #{apcCd}
					, #{apcNm}
					, #{sprtBiz}
					, #{bizCn}
					, #{bizNm}
					, #{bizCd}
					, #{ne}
					, #{lcltExpnd}
					, #{slfBrdn}
					, #{lcltExpndCtpv}
					, #{lcltExpndSgg}

					, SYSDATE
					, #{sysFrstInptUserId}
					, #{sysFrstInptPrgrmId}
					, SYSDATE
					, #{sysLastChgUserId}
					, #{sysLastChgPrgrmId}
				)
		]]>
	</insert>
	-->

	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.fm.fclt.mapper.FcltInstlInfoMapper.updateFcltInstlInfo				-->
	<!-- DESC : 시설설치보완 변경                                             				-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.06.09  	kimho        	Initial Creation                            -->
	<!-- ==========================================================================	-->
	<update id="updateFcltInstlInfo" parameterType="com.at.apcss.fm.fclt.vo.FcltInstlInfoVO">
		<![CDATA[
			UPDATE /* com.at.apcss.fm.fclt.mapper.FcltInstlInfoMapper.updateFcltInstlInfo */
				TB_TE_APC_FCLT_INSTL_SPLMNT AFIS
			   SET
				 BIZ_YR				= #{bizYr}
				, SPRT_BIZ			= #{sprtBiz}
				, BIZ_CN			= #{bizCn}
				, BIZ_NM			= #{bizNm}
				, BIZ_CD			= #{bizCd}
				, NE				= #{ne}
				, LCLT_EXPND		= #{lcltExpnd}
				, SLF_BRDN			= #{slfBrdn}
				, LCLT_EXPND_CTPV	= #{lcltExpndCtpv}
				, LCLT_EXPND_SGG	= #{lcltExpndSgg}

		]]>
		<if test='delYn != null and delYn != ""'>
				, DEL_YN 	= #{delYn}
		</if>
		<![CDATA[
				, SYS_LAST_CHG_DT		= SYSDATE
				, SYS_LAST_CHG_USER_ID	= #{sysLastChgUserId}
				, SYS_LAST_CHG_PRGRM_ID	= #{sysLastChgPrgrmId}
			WHERE 1=1
			  AND AFIS.SN 		= #{sn}
			  AND AFIS.APC_CD 	= #{apcCd}
		]]>
	</update>

	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.fm.fclt.mapper.FcltInstlInfoMapper.deleteFcltInstlInfo				-->
	<!-- DESC : 시설설치보완 삭제                                             				-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.06.09  	kimho        	Initial Creation                            -->
	<!-- ==========================================================================	-->
	<update id="deleteFcltInstlInfo" parameterType="com.at.apcss.fm.fclt.vo.FcltInstlInfoVO">
		<![CDATA[
			UPDATE /* com.at.apcss.fm.fclt.mapper.FcltInstlInfoMapper.deleteFcltInstlInfo */
				TB_TE_APC_FCLT_INSTL_SPLMNT FCLT
			   SET
				  DEL_YN 	= 'Y'
			WHERE 1=1
			  AND SN 	 = #{sn}
			  AND APC_CD = #{apcCd}
		]]>
	</update>
	<!--
	<delete id="deleteFcltInstlInfo" parameterType="com.at.apcss.fm.fclt.vo.FcltInstlInfoVO">
		<![CDATA[
			DELETE /* com.at.apcss.fm.fclt.mapper.FcltInstlInfoMapper.deleteFcltInstlInfo */
				TB_FCLT_INSTL_INFO FCLT
			 WHERE 1=1
			 AND SN 	= #{sn}
			  AND TRGT_YR = #{trgtYr}
			  AND  APC_CD = #{apcCd}
		]]>
	</delete>
	-->

	<select id="selectFcltInstlInfoRawDataList" parameterType="com.at.apcss.fm.fclt.vo.FcltInstlInfoVO" resultType="com.at.apcss.fm.fclt.vo.FcltInstlInfoVO">
		<![CDATA[
			SELECT /* com.at.apcss.fm.fclt.mapper.FcltInstlInfoMapper.selectFcltInstlInfoRawDataList */
				AFIS.SN
				, AFIS.BIZ_YR
				, AFIS.APC_CD
				, AFIS.APC_NM
				, AFIS.SPRT_BIZ
				, FN_GET_COM_CD_VL_NM('BIZ_SPRT_CD',AFIS.SPRT_BIZ) AS SPRT_BIZ_NM
				, AFIS.BIZ_CN
				, AFIS.NE
				, AFIS.LCLT_EXPND
				, AFIS.SLF_BRDN
				, AFIS.BIZ_NM
				, AFIS.BIZ_CD
				, AFIS.LCLT_EXPND_CTPV
				, AFIS.LCLT_EXPND_SGG

			FROM TB_TE_APC_FCLT_INSTL_SPLMNT AFIS
			WHERE 1=1
			  AND AFIS.DEL_YN = 'N'
			  AND AFIS.BIZ_YR IS NOT NULL
			 ]]>
			<if test='userId != null and userId != ""'>
				<if test='userType == "27" or userType == "28"'>
				AND AFIS.APC_CD IN (SELECT APC_CD
								FROM TB_APC_INFO
								WHERE 1=1
								<if test='userType == "27"'>
								  AND CTPV = (SELECT CTPV FROM TB_COM_USER WHERE USER_ID = #{userId})
								</if>
								<if test='userType == "28"'>
								  AND SGG = (SELECT SGG FROM TB_COM_USER WHERE USER_ID = #{userId})
								</if>
								)
				</if>
			</if>
			ORDER BY APC_NM , BIZ_YR , SPRT_BIZ , BIZ_NM

	</select>

</mapper>