<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- ==========================================================================	-->
<!-- NAME : LoginMapper.xml                                    					-->
<!-- DESC : login mapper                                             			-->
<!-- ==========================================================================	-->
<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
<!-- ===========  	============  	===========================================	-->
<!-- 2023.06.13  	jcshin        	Initial Creation                            -->
<!-- ==========================================================================	-->

<mapper namespace="com.at.apcss.co.sys.mapper.LoginMapper">

	<resultMap type="com.at.apcss.co.sys.vo.LoginVO" id="loginMap">
		<result property="id" column="ID"/>
		<result property="name" column="NAME"/>
		<result property="email" column="EMAIL"/>
		<result property="password" column="PASSWORD"/>
		<result property="userId" column="USER_ID"/>
		<result property="pswd" column="PSWD"/>
		<result property="apcCd" column="APC_CD"/>
		<result property="apcNm" column="APC_NM"/>
		<result property="userType" column="USER_TYPE"/>
		<result property="userStts" column="USER_STTS"/>
		<result property="lgnFailNmtm" column="LGN_FAIL_NMTM"/>
		<result property="endLgnIp" column="END_LGN_IP"/>
		<result property="lckYn" column="LCK_YN"/>
	</resultMap>


	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.co.sys.mapper.LoginMapper.selectUser                  	-->
	<!-- DESC : 계정정보 조회.                                             				-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.06.18  	jcshin        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <select id="selectUser" parameterType="com.at.apcss.co.sys.vo.LoginVO" resultMap="loginMap">
    	<![CDATA[
			SELECT /* com.at.apcss.co.sys.mapper.LoginMapper.selectUser */
				  CU.USER_ID		AS ID
				, CU.USER_NM		AS NAME
				, CU.PSWD			AS PASSWORD
				, CU.USER_ID		AS USER_ID
				, CU.PSWD			AS PSWD
				, CU.USER_TYPE		AS USER_TYPE
				, CU.USER_STTS		AS USER_STTS
				, CU.EML			AS EMAIL
				, CU.TELNO			AS TELNO
				, CU.APC_CD			AS APC_CD
				, (SELECT FN_GET_APC_NM(CU.APC_CD) FROM DUAL) AS APC_NM
				, CU.CHRGD_CERT_YN		AS CHRGD_CERT_YN
				, CU.CHRGD_CERT_TYPE	AS CHRGD_CERT_TYPE
				, CU.LGN_FAIL_NMTM		AS LGN_FAIL_NMTM
				, CU.END_LGN_DT		AS END_LGN_DT
				, CU.END_LGN_IP		AS END_LGN_IP
				, CU.DEL_YN			AS DEL_YN
				, CU.LCK_YN			AS LCK_YN
			  FROM TB_COM_USER CU
			 WHERE CU.USER_ID = #{id}
    	]]>
    </select>

	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.co.sys.mapper.LoginMapper.actionLogin                  -->
	<!-- DESC : 로그인 처리.                                             				-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.06.18  	jcshin        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <select id="actionLogin" parameterType="com.at.apcss.co.sys.vo.LoginVO" resultMap="loginMap">
    	<![CDATA[
			SELECT /* com.at.apcss.co.sys.mapper.LoginMapper.actionLogin */
				  CU.USER_ID		AS ID
				, CU.USER_NM		AS NAME
				, CU.PSWD			AS PASSWORD
				, CU.USER_ID		AS USER_ID
				, CU.PSWD			AS PSWD
				, CU.USER_TYPE		AS USER_TYPE
				, CU.USER_STTS		AS USER_STTS
				, CU.EML			AS EMAIL
				, CU.TELNO			AS TELNO
				, CU.APC_CD			AS APC_CD
				, CU.BRNO			AS BRNO
				, (SELECT FN_GET_APC_NM(CU.APC_CD) FROM DUAL) AS APC_NM
				, (SELECT X.APC_SE_CD FROM TB_APC_EVRMNT_STNG X WHERE X.APC_CD = CU.APC_CD) AS APC_SE_CD

				, CU.CHRGD_CERT_YN		AS CHRGD_CERT_YN
				, CU.CHRGD_CERT_TYPE	AS CHRGD_CERT_TYPE
				, CU.LGN_FAIL_NMTM		AS LGN_FAIL_NMTM
				, CU.END_LGN_DT		AS END_LGN_DT
				, CU.END_LGN_IP		AS END_LGN_IP
				, CU.DEL_YN			AS DEL_YN
			  FROM TB_COM_USER CU
			 WHERE CU.USER_ID = #{id}
			   AND CU.PSWD = #{password}
			   -- AND CU.USER_STTS = '01'	-- 사용자 상태: 01 사용
			   AND CU.DEL_YN = 'N'
    	]]>
    </select>


	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.co.sys.mapper.LoginMapper.actionSSOLogin               -->
	<!-- DESC : SSO 로그인 처리.                                             			-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.06.18  	jcshin        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <select id="actionSSOLogin" parameterType="com.at.apcss.co.sys.vo.LoginVO" resultMap="loginMap">
    	<![CDATA[
			SELECT /* com.at.apcss.co.sys.mapper.LoginMapper.actionSSOLogin */
				  CU.USER_ID		AS ID
				, CU.USER_NM		AS NAME
				, CU.PSWD			AS PASSWORD
				, CU.USER_ID		AS USER_ID
				, CU.PSWD			AS PSWD
				, CU.USER_TYPE		AS USER_TYPE
				, CU.USER_STTS		AS USER_STTS
				, CU.EML			AS EMAIL
				, CU.TELNO			AS TELNO
				, CU.APC_CD			AS APC_CD
				, (SELECT FN_GET_APC_NM(CU.APC_CD) FROM DUAL) AS APC_NM
				, (SELECT X.APC_SE_CD FROM TB_APC_EVRMNT_STNG X WHERE X.APC_CD = CU.APC_CD) AS APC_SE_CD

				, CU.CHRGD_CERT_YN		AS CHRGD_CERT_YN
				, CU.CHRGD_CERT_TYPE	AS CHRGD_CERT_TYPE
				, CU.LGN_FAIL_NMTM		AS LGN_FAIL_NMTM
				, CU.END_LGN_DT		AS END_LGN_DT
				, CU.END_LGN_IP		AS END_LGN_IP
				, CU.DEL_YN			AS DEL_YN
			  FROM TB_COM_USER CU
			 WHERE CU.USER_ID = #{id}
			   AND CU.USER_STTS = '01'	-- 사용자 상태: 01 사용
			   AND CU.DEL_YN = 'N'
    	]]>
    </select>


	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.co.sys.mapper.LoginMapper.searchId                  	-->
	<!-- DESC : 아이디 찾기.                                             				-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.06.18  	jcshin        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <select id="searchId" parameterType="com.at.apcss.co.sys.vo.LoginVO" resultMap="loginMap">
    	<![CDATA[
			SELECT /* com.at.apcss.co.sys.mapper.LoginMapper.searchId */
				  CU.USER_ID		AS ID
			  FROM TB_COM_USER CU
			 WHERE CU.USER_NM = #{name}
			   AND CU.EML = #{email}
			   AND CU.USER_STTS = '01'	-- 사용자 상태: 01 사용
			   AND CU.DEL_YN = 'N'
    	]]>
    </select>

	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.co.sys.mapper.LoginMapper.searchPassword   			-->
	<!-- DESC : 비밀번호 찾기.                                             				-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.06.18  	jcshin        	Initial Creation                            -->
	<!-- ==========================================================================	-->
    <select id="searchPassword" parameterType="com.at.apcss.co.sys.vo.LoginVO" resultMap="loginMap">
    	<![CDATA[
			SELECT /* com.at.apcss.co.sys.mapper.LoginMapper.searchPassword */
				  CU.USER_ID		AS ID
				, CU.PSWD			AS PASSWORD
			  FROM TB_COM_USER CU
			 WHERE CU.USER_ID = #{id}
			   AND CU.EML = #{email}
			   AND CU.USER_STTS = '01'	-- 사용자 상태: 01 사용
			   AND CU.DEL_YN = 'N'
    	]]>
    </select>
	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.co.sys.mapper.LoginMapper.updateFailCount   			-->
	<!-- DESC : 실패횟수 저장                                           				-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.11.13  	MS    	     	Initial Creation                            -->
	<!-- ==========================================================================	-->
	<update id="updateFailCount" parameterType="com.at.apcss.co.sys.vo.LoginVO">
		<selectKey keyProperty="lgnFailNmtm" resultType="int" order="BEFORE" >
			SELECT LGN_FAIL_NMTM FROM TB_COM_USER WHERE USER_ID=#{id}
		</selectKey>
		UPDATE TB_COM_USER AS CU
			SET LGN_FAIL_NMTM =#{lgnFailNmtm}+1
			WHERE CU.USER_ID = #{id}
	</update>
	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.co.sys.mapper.LoginMapper.updateUserLck   			-->
	<!-- DESC : 실패횟수 5회이상 계정잠금처리                                        				-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.11.13  	MS    	     	Initial Creation                            -->
	<!-- ==========================================================================	-->
	<update id="updateUserLck" parameterType="com.at.apcss.co.sys.vo.LoginVO">
		UPDATE TB_COM_USER
		SET LCK_YN = 'Y'
		WHERE USER_ID = #{id}
	</update>
	<!-- ==========================================================================	-->
	<!-- NAME : com.at.apcss.co.sys.mapper.LoginMapper.updateResetFailCount   			-->
	<!-- DESC : 로그인 성공시 실패카운트 초기화                                   				-->
	<!-- ==========================================================================	-->
	<!-- DATE   		AUTHOR        	DESCRIPTION                      			-->
	<!-- ===========  	============  	===========================================	-->
	<!-- 2023.11.14  	MS    	     	Initial Creation                            -->
	<!-- ==========================================================================	-->
	<update id="updateResetFailCount" parameterType="com.at.apcss.co.sys.vo.LoginVO">
		UPDATE TB_COM_USER
		SET LGN_FAIL_NMTM = 0
		WHERE USER_ID = #{id}
	</update>
</mapper>